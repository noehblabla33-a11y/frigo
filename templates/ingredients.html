{% extends "base.html" %}
{% from "macros/pagination.html" import render_pagination %}
{% block title %}Catalogue d'ingr√©dients{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='style/pagination.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style/collapsable.css') }}">
{% endblock %}

{% block content %}

<!-- Barre de recherche et filtres -->
<div class="card">
    <h3>üîç Rechercher et filtrer</h3>
    <form method="GET" action="{{ url_for('ingredients.liste') }}">
        <div class="search-filters">
            <div class="form-group" style="flex: 2;">
                <label>Recherche par nom</label>
                <input type="text" name="search" placeholder="Ex: Tomate, Oignon..." 
                       value="{{ search_query }}">
            </div>
            
            <div class="form-group" style="flex: 1;">
                <label>Cat√©gorie</label>
                <select name="categorie" class="searchable-select">
                    <option value="">Toutes les cat√©gories</option>
                    {% for cat_name, cat_icon in categories %}
                    <option value="{{ cat_name }}" {% if categorie_filter == cat_name %}selected{% endif %}>
                        {{ cat_icon }} {{ cat_name }}
                        {% if cat_name in categories_count %}({{ categories_count[cat_name] }}){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group" style="flex: 1;">
                <label>Stock</label>
                <select name="stock">
                    <option value="">Tous</option>
                    <option value="en_stock" {% if stock_filter == 'en_stock' %}selected{% endif %}>En stock</option>
                    <option value="pas_en_stock" {% if stock_filter == 'pas_en_stock' %}selected{% endif %}>Pas en stock</option>
                </select>
            </div>
            
            <div class="form-group" style="flex: 0; align-self: flex-end;">
                <button type="submit" class="btn">üîç Rechercher</button>
            </div>
            
            {% if search_query or categorie_filter or stock_filter %}
            <div class="form-group" style="flex: 0; align-self: flex-end;">
                <a href="{{ url_for('ingredients.liste') }}" class="btn btn-secondary">‚úñ Effacer</a>
            </div>
            {% endif %}
        </div>
        <input type="hidden" name="view" value="{{ view_mode }}">
    </form>
    
    {% if search_query or categorie_filter or stock_filter %}
    <div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 5px;">
        <strong>Filtres actifs :</strong>
        {% if search_query %}
        <span class="filter-badge">Recherche: "{{ search_query }}"</span>
        {% endif %}
        {% if categorie_filter %}
        <span class="filter-badge">Cat√©gorie: {{ categorie_filter }}</span>
        {% endif %}
        {% if stock_filter == 'en_stock' %}
        <span class="filter-badge">En stock uniquement</span>
        {% elif stock_filter == 'pas_en_stock' %}
        <span class="filter-badge">Pas en stock</span>
        {% endif %}
        <span style="color: #666;">({{ pagination.total }} r√©sultat(s))</span>
    </div>
    {% endif %}
</div>

<!-- Formulaire d'ajout (COLLAPSABLE) -->
<div class="card card-collapsable">
    <div class="collapsable-header" data-collapsable="form-ajout-ingredient">
        <h3>‚ûï Ajouter un ingr√©dient au catalogue </h3>
    </div>
    
    <div id="form-ajout-ingredient" class="collapsable-content">
        <form method="POST" enctype="multipart/form-data">
            <div class="form-group">
                <label>Nom de l'ingr√©dient</label>
                <input type="text" name="nom" required>
            </div>
            
            <div class="form-group">
                <label>Cat√©gorie</label>
                <select name="categorie" class="searchable-select">
                    <option value="">S√©lectionner une cat√©gorie (optionnel)</option>
                    {% for cat_name, cat_icon in categories %}
                    <option value="{{ cat_name }}">{{ cat_icon }} {{ cat_name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label>Unit√© de mesure</label>
                <select name="unite">
                    <option value="g">grammes (g)</option>
                    <option value="kg">kilogrammes (kg)</option>
                    <option value="ml">millilitres (ml)</option>
                    <option value="L">litres (L)</option>
                    <option value="pi√®ce">pi√®ce(s)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Prix unitaire (‚Ç¨)</label>
                <input type="number" step="0.01" name="prix_unitaire" placeholder="Prix par unit√© (optionnel)">
                <small style="color: #6c757d;">Ex: 2.50 pour 2.50‚Ç¨/kg ou 2.50‚Ç¨/L</small>
            </div>
            
            <div class="form-group">
                <label>Image de l'ingr√©dient</label>
                <input type="file" name="image" accept="image/*">
            </div>
            
            <button type="submit" class="btn">Ajouter au catalogue</button>
        </form>
    </div>
</div>

<!-- Catalogue d'ingr√©dients -->
<div class="card">
    <div class="catalogue-header">
        <h3>üì¶ Catalogue d'ingr√©dients</h3>
        <div class="view-toggle">
            <a href="{{ url_for('ingredients.liste', search=search_query, categorie=categorie_filter, stock=stock_filter, view='grid') }}" 
               class="view-toggle-btn {% if view_mode == 'grid' %}active{% endif %}"
               title="Vue en grille">
                <span class="icon">‚äû</span>
            </a>
            <a href="{{ url_for('ingredients.liste', search=search_query, categorie=categorie_filter, stock=stock_filter, view='list') }}" 
               class="view-toggle-btn {% if view_mode == 'list' %}active{% endif %}"
               title="Vue en liste">
                <span class="icon">‚ò∞</span>
            </a>
        </div>
    </div>
    
    <p style="margin-bottom: 20px;">
        G√©rez ici tous les ingr√©dients que vous utilisez dans vos recettes.
        {% if pagination.total > 0 %}
        <strong>{{ pagination.total }}</strong> ingr√©dient(s) au total.
        {% endif %}
    </p>
    
    {% if ingredients %}
        {% if view_mode == 'list' %}
        <!-- MODE LISTE -->
        <div class="item-list">
            <table class="item-table">
                <thead>
                    <tr>
                        <th style="width: 60px;"></th>
                        <th>Nom</th>
                        <th>Cat√©gorie</th>
                        <th>Unit√©</th>
                        <th>Prix</th>
                        <th>Stock</th>
                        <th style="text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ing in ingredients %}
                    <tr>
                        <td class="item-img-cell">
                            {% if ing.image %}
                            <img src="{{ url_for('static', filename=ing.image.replace('static/', '')) }}" 
                                 alt="{{ ing.nom }}" 
                                 class="item-thumbnail"
                                 loading="lazy">
                            {% else %}
                            <div class="item-thumbnail-placeholder">üì¶</div>
                            {% endif %}
                        </td>
                        <td class="item-name-cell">
                            <strong>{{ ing.nom }}</strong>
                        </td>
                        <td>
                            {% if ing.categorie %}
                            <span class="category-badge-small badge">
                                {% for cat_name, cat_icon in categories %}
                                    {% if cat_name == ing.categorie %}
                                        {{ cat_icon }} {{ cat_name }}
                                    {% endif %}
                                {% endfor %}
                            </span>
                            {% else %}
                            <span style="color: #adb5bd;">-</span>
                            {% endif %}
                        </td>
                        <td>{{ ing.unite }}</td>
                        <td>
                            {% if ing.prix_unitaire > 0 %}
                            <span class="prix-table">{{ ing.prix_unitaire }}‚Ç¨/{{ ing.unite }}</span>
                            {% else %}
                            <span style="color: #adb5bd;">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if ing.stock %}
                            <span class="stock-badge stock-available badge">
                                ‚úì {{ ing.stock.quantite }} {{ ing.unite }}
                            </span>
                            {% else %}
                            <span class="stock-badge stock-empty badge">‚úó Pas en stock</span>
                            {% endif %}
                        </td>
                        <td class="actions-cell">
                            <a href="{{ url_for('ingredients.modifier', id=ing.id) }}" 
                               class="btn-icon" 
                               title="Modifier">‚úèÔ∏è</a>
                            <a href="{{ url_for('ingredients.supprimer', id=ing.id) }}" 
                               class="btn-icon btn-icon-danger" 
                               title="Supprimer"
                               onclick="return confirm('Supprimer cet ingr√©dient ?')">üóëÔ∏è</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <!-- MODE GRILLE -->
        <div class="item-grid">
            {% for ing in ingredients %}
            <div class="item-card">
                {% if ing.categorie %}
                <div class="category-badge">
                    {% for cat_name, cat_icon in categories %}
                        {% if cat_name == ing.categorie %}
                            {{ cat_icon }} {{ cat_name }}
                        {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
                <div class="item-image">
                    {% if ing.image %}
                    <img src="{{ url_for('static', filename=ing.image.replace('static/', '')) }}" 
                         alt="{{ ing.nom }}"
                         loading="lazy">
                    {% else %}
                    <div class="no-image">üì¶</div>
                    {% endif %}
                </div>
                <div class="item-info">
                    <h4>{{ ing.nom }}</h4>
                    <p class="ingredient-unite">Unit√©: {{ ing.unite }}</p>
                    {% if ing.prix_unitaire > 0 %}
                    <p class="ingredient-prix">{{ ing.prix_unitaire }}‚Ç¨/{{ ing.unite }}</p>
                    {% endif %}
                    {% if ing.stock %}
                    <p class="ingredient-stock">En stock: {{ ing.stock.quantite }} {{ ing.unite }}</p>
                    {% else %}
                    <p class="ingredient-stock-vide">Pas en stock</p>
                    {% endif %}
                </div>
                <div class="item-actions">
                    <a href="{{ url_for('ingredients.modifier', id=ing.id) }}" class="btn btn-small">Modifier</a>
                    <a href="{{ url_for('ingredients.supprimer', id=ing.id) }}" 
                       class="btn btn-danger btn-small" 
                       onclick="return confirm('Supprimer cet ingr√©dient ?')">
                        Supprimer
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- Pagination -->
        {{ render_pagination(pagination, 'ingredients.liste',
                           search=search_query,
                           categorie=categorie_filter,
                           stock=stock_filter,
                           view=view_mode) }}
    {% else %}
    <p>Aucun ingr√©dient trouv√©. 
        {% if search_query or categorie_filter or stock_filter %}
        Essayez de modifier vos crit√®res de recherche.
        {% else %}
        Utilisez le formulaire ci-dessus pour en ajouter !
        {% endif %}
    </p>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='javascript/collapsable.js') }}"></script>
{% endblock %}
