{% extends "base.html" %}
{% from "macros/pagination.html" import render_pagination %}
{% from "macros/search_filters.html" import render_search_form, render_empty_state %}
{% block title %}Catalogue des ingr√©dients{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='style/pagination.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style/collapsable.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style/ingredients.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style/search-filters.css') }}">
{% endblock %}

{% block content %}
<script>document.body.dataset.page = 'ingredients';</script>

{# ============================================ #}
{# FORMULAIRE DE RECHERCHE (FACTORIS√â) #}
{# ============================================ #}
{% set category_options = [] %}
{% for cat_name, cat_icon in categories %}
    {% set count = categories_count.get(cat_name, 0) %}
    {% set _ = category_options.append({
        'value': cat_name,
        'text': cat_icon ~ ' ' ~ cat_name,
        'count': count if count > 0 else none
    }) %}
{% endfor %}

{% set stock_options = [
    ('en_stock', 'En stock'),
    ('pas_en_stock', 'Pas en stock')
] %}

{% set filters = [
    {
        'name': 'categorie',
        'label': 'Cat√©gorie',
        'type': 'select',
        'searchable': true,
        'placeholder': 'Toutes les cat√©gories',
        'options': category_options,
        'selected': categorie_filter
    },
    {
        'name': 'stock',
        'label': 'Stock',
        'type': 'select_simple',
        'placeholder': 'Tous',
        'options': stock_options,
        'selected': stock_filter
    }
] %}

{% set active_filters = {} %}
{% if categorie_filter %}
    {% set _ = active_filters.update({'categorie': {'label': 'Cat√©gorie', 'value': categorie_filter}}) %}
{% endif %}
{% if stock_filter == 'en_stock' %}
    {% set _ = active_filters.update({'stock': {'label': 'Stock', 'value': stock_filter, 'display': 'En stock uniquement'}}) %}
{% elif stock_filter == 'pas_en_stock' %}
    {% set _ = active_filters.update({'stock': {'label': 'Stock', 'value': stock_filter, 'display': 'Pas en stock'}}) %}
{% endif %}

{{ render_search_form(
    endpoint='ingredients.liste',
    search_value=search_query,
    search_placeholder='Ex: Tomate, Oignon...',
    filters=filters,
    active_filters=active_filters
) }}

{# Afficher le nombre de r√©sultats si filtres actifs #}
{% if (search_query or categorie_filter or stock_filter) and pagination.total is defined %}
<div style="margin: -10px 0 20px 0; padding-left: 5px;">
    <span style="color: var(--text-secondary);">{{ pagination.total }} r√©sultat(s)</span>
</div>
{% endif %}

{# ============================================ #}
{# FORMULAIRE D'AJOUT (COLLAPSABLE) #}
{# ============================================ #}
<div class="card">
    <h3 data-collapsable="add-form" class="collapsable-header">
        ‚ûï Ajouter un ingr√©dient
    </h3>
    <div id="add-form" class="collapsable-content">
        <form method="POST" enctype="multipart/form-data">
            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label>Nom de l'ingr√©dient *</label>
                    <input type="text" name="nom" required placeholder="Ex: Tomates cerises">
                </div>
                
                <div class="form-group" style="flex: 1;">
                    <label>Unit√©</label>
                    <select name="unite">
                        <option value="g">Grammes (g)</option>
                        <option value="ml">Millilitres (ml)</option>
                        <option value="pi√®ce">Pi√®ce</option>
                    </select>
                </div>
                
                <div class="form-group" style="flex: 1;">
                    <label>Prix unitaire (‚Ç¨)</label>
                    <input type="number" name="prix_unitaire" step="0.001" min="0" placeholder="0.00">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label>Cat√©gorie</label>
                    <select name="categorie" class="searchable-select">
                        <option value="">Aucune</option>
                        {% for cat_name, cat_icon in categories %}
                        <option value="{{ cat_name }}">{{ cat_icon }} {{ cat_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group" style="flex: 1;">
                    <label>Poids par pi√®ce (g)</label>
                    <input type="number" name="poids_piece" step="0.1" min="0" 
                           placeholder="Si unit√© = pi√®ce">
                </div>
                
                <div class="form-group" style="flex: 1;">
                    <label>Image</label>
                    <input type="file" name="image" accept="image/*">
                </div>
            </div>
            
            {# Valeurs nutritionnelles (collapsable) #}
            <details class="nutrition-details">
                <summary>üìä Valeurs nutritionnelles (optionnel)</summary>
                <div class="form-row" style="margin-top: 15px;">
                    <div class="form-group">
                        <label>Calories (kcal/100g)</label>
                        <input type="number" name="calories" step="0.1" min="0">
                    </div>
                    <div class="form-group">
                        <label>Prot√©ines (g/100g)</label>
                        <input type="number" name="proteines" step="0.1" min="0">
                    </div>
                    <div class="form-group">
                        <label>Glucides (g/100g)</label>
                        <input type="number" name="glucides" step="0.1" min="0">
                    </div>
                    <div class="form-group">
                        <label>Lipides (g/100g)</label>
                        <input type="number" name="lipides" step="0.1" min="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Fibres (g/100g)</label>
                        <input type="number" name="fibres" step="0.1" min="0">
                    </div>
                    <div class="form-group">
                        <label>Sucres (g/100g)</label>
                        <input type="number" name="sucres" step="0.1" min="0">
                    </div>
                    <div class="form-group">
                        <label>Sel (g/100g)</label>
                        <input type="number" name="sel" step="0.01" min="0">
                    </div>
                </div>
            </details>
            
            <button type="submit" class="btn btn-success">‚úì Ajouter l'ingr√©dient</button>
        </form>
    </div>
</div>

{# ============================================ #}
{# LISTE DES INGR√âDIENTS #}
{# ============================================ #}
<div class="card">
    <div class="catalogue-header">
        <h3>üì¶ Catalogue des ingr√©dients</h3>
    </div>
    
    <p style="margin-bottom: 20px;">
        Voici tous les ingr√©dients disponibles dans votre catalogue.
        {% if pagination.total > 0 %}
        <strong>{{ pagination.total }}</strong> ingr√©dient(s) au total.
        {% endif %}
    </p>
    
    {% if ingredients %}
        <div class="item-list">
            <table class="item-table">
                <thead>
                    <tr>
                        <th style="width: 60px;"></th>
                        <th>Nom</th>
                        <th>Cat√©gorie</th>
                        <th>Unit√©</th>
                        <th>Prix (en kg/L)</th>
                        <th style="text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ing in ingredients %}
                    <tr>
                        <td class="item-img-cell">
                            {% if ing.image %}
                            <img src="{{ url_for('static', filename=ing.image) }}" 
                                alt="{{ ing.nom }}" 
                                class="item-thumbnail"
                                loading="lazy">
                            {% else %}
                            <div class="item-thumbnail-placeholder">üì¶</div>
                            {% endif %}
                        </td>
                        <td class="item-name-cell">
                            <strong>{{ ing.nom }}</strong>
                        </td>
                        <td>
                            {% if ing.categorie %}
                            <span class="category-badge-small badge">
                                {% for cat_name, cat_icon in categories %}
                                    {% if cat_name == ing.categorie %}
                                        {{ cat_icon }} {{ cat_name }}
                                    {% endif %}
                                {% endfor %}
                            </span>
                            {% else %}
                            <span style="color: #adb5bd;">-</span>
                            {% endif %}
                        </td>
                        <td>{{ ing.unite }}</td>
                        <td>
                            {{ ing.prix_unitaire|prix_lisible(ing.unite, ing) }}
                        </td>
                        <td class="actions-cell">
                            <a href="{{ url_for('ingredients.modifier', id=ing.id) }}" 
                               class="btn-icon" 
                               title="Modifier">‚úèÔ∏è</a>
                            {# ‚úÖ FACTORIS√â : Utilisation de data-confirm au lieu de onclick #}
                            <a href="{{ url_for('ingredients.supprimer', id=ing.id) }}" 
                               class="btn-icon btn-icon-danger" 
                               title="Supprimer"
                               data-confirm="Supprimer l'ingr√©dient ¬´ {{ ing.nom }} ¬ª ?">üóëÔ∏è</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {# Pagination #}
        {{ render_pagination(pagination, 'ingredients.liste',
                           search=search_query,
                           categorie=categorie_filter,
                           stock=stock_filter) }}
    {% else %}
        {# √âtat vide (factoris√©) #}
        {{ render_empty_state(
            icon='üì¶',
            message='Aucun ingr√©dient trouv√©.',
            has_filters=(search_query or categorie_filter or stock_filter),
            filter_message='Essayez de modifier vos crit√®res de recherche.',
            add_message='Utilisez le formulaire ci-dessus pour en ajouter !'
        ) }}
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{# Note: common.js doit √™tre inclus dans base.html #}
<script src="{{ url_for('static', filename='javascript/collapsable.js') }}"></script>
<script src="{{ url_for('static', filename='javascript/price-helper.js') }}"></script>
{% endblock %}
