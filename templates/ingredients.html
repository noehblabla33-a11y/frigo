{% extends "base.html" %}
{% block title %}Catalogue d'ingr√©dients{% endblock %}

{% block content %}

<!-- Barre de recherche et filtres -->
<div class="card">
    <h3>üîç Rechercher et filtrer</h3>
    <form method="GET" action="{{ url_for('ingredients.liste') }}">
        <div class="search-filters">
            <div class="form-group" style="flex: 2;">
                <label>Recherche par nom</label>
                <input type="text" name="search" placeholder="Ex: Tomate, Oignon..." 
                       value="{{ search_query }}">
            </div>
            
            <div class="form-group" style="flex: 1;">
                <label>Cat√©gorie</label>
                <select name="categorie" class="searchable-select">
                    <option value="">Toutes les cat√©gories</option>
                    {% for cat_name, cat_icon in categories %}
                    <option value="{{ cat_name }}" {% if categorie_filter == cat_name %}selected{% endif %}>
                        {{ cat_icon }} {{ cat_name }}
                        {% if cat_name in categories_count %}({{ categories_count[cat_name] }}){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group" style="flex: 1;">
                <label>Stock</label>
                <select name="stock">
                    <option value="">Tous</option>
                    <option value="en_stock" {% if stock_filter == 'en_stock' %}selected{% endif %}>En stock</option>
                    <option value="pas_en_stock" {% if stock_filter == 'pas_en_stock' %}selected{% endif %}>Pas en stock</option>
                </select>
            </div>
            
            <div class="form-group" style="flex: 0; align-self: flex-end;">
                <button type="submit" class="btn">üîç Rechercher</button>
            </div>
            
            {% if search_query or categorie_filter or stock_filter %}
            <div class="form-group" style="flex: 0; align-self: flex-end;">
                <a href="{{ url_for('ingredients.liste') }}" class="btn btn-secondary">‚úñ Effacer</a>
            </div>
            {% endif %}
        </div>
    </form>
    
    {% if search_query or categorie_filter or stock_filter %}
    <div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 5px;">
        <strong>Filtres actifs :</strong>
        {% if search_query %}
        <span class="filter-badge">Recherche: "{{ search_query }}"</span>
        {% endif %}
        {% if categorie_filter %}
        <span class="filter-badge">Cat√©gorie: {{ categorie_filter }}</span>
        {% endif %}
        {% if stock_filter == 'en_stock' %}
        <span class="filter-badge">En stock uniquement</span>
        {% elif stock_filter == 'pas_en_stock' %}
        <span class="filter-badge">Pas en stock</span>
        {% endif %}
        <span style="color: #666;">({{ ingredients|length }} r√©sultat(s))</span>
    </div>
    {% endif %}
</div>

<div class="card">
    <h3>‚ûï Ajouter un ingr√©dient au catalogue</h3>
    <form method="POST" enctype="multipart/form-data">
        <div class="form-group">
            <label>Nom de l'ingr√©dient</label>
            <input type="text" name="nom" required>
        </div>
        
        <div class="form-group">
            <label>Cat√©gorie</label>
            <select name="categorie" class="searchable-select">
                <option value="">S√©lectionner une cat√©gorie (optionnel)</option>
                {% for cat_name, cat_icon in categories %}
                <option value="{{ cat_name }}">{{ cat_icon }} {{ cat_name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label>Unit√© de mesure</label>
            <select name="unite">
                <option value="g">grammes (g)</option>
                <option value="kg">kilogrammes (kg)</option>
                <option value="ml">millilitres (ml)</option>
                <option value="L">litres (L)</option>
                <option value="pi√®ce">pi√®ce(s)</option>
            </select>
        </div>
        <div class="form-group">
            <label>Prix unitaire (‚Ç¨)</label>
            <input type="number" step="0.01" name="prix_unitaire" placeholder="Prix par unit√© (optionnel)">
            <small style="color: #6c757d;">Ex: 2.50 pour 2.50‚Ç¨/kg ou 2.50‚Ç¨/L</small>
        </div>
        <div class="form-group">
            <label>Image de l'ingr√©dient</label>
            <input type="file" name="image" accept="image/*">
        </div>
        <button type="submit" class="btn">Ajouter au catalogue</button>
    </form>
</div>

<div class="card">
    <h3>üì¶ Catalogue d'ingr√©dients</h3>
    <p style="margin-bottom: 20px;">
        G√©rez ici tous les ingr√©dients que vous utilisez dans vos recettes.
        {% if ingredients|length > 0 %}
        <strong>{{ ingredients|length }}</strong> ingr√©dient(s) affich√©(s).
        {% endif %}
    </p>
    {% if ingredients %}
    <div class="ingredient-grid">
        {% for ing in ingredients %}
        <div class="ingredient-card">
            {% if ing.categorie %}
            <div class="category-badge">
                {% for cat_name, cat_icon in categories %}
                    {% if cat_name == ing.categorie %}
                        {{ cat_icon }} {{ cat_name }}
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}
            <div class="ingredient-image">
                {% if ing.image %}
                <img src="{{ url_for('static', filename=ing.image.replace('static/', '')) }}" alt="{{ ing.nom }}">
                {% else %}
                <div class="no-image">üì¶</div>
                {% endif %}
            </div>
            <div class="ingredient-info">
                <h4>{{ ing.nom }}</h4>
                <p class="ingredient-unite">Unit√©: {{ ing.unite }}</p>
                {% if ing.prix_unitaire > 0 %}
                <p class="ingredient-prix">{{ ing.prix_unitaire }}‚Ç¨/{{ ing.unite }}</p>
                {% endif %}
                {% if ing.stock %}
                <p class="ingredient-stock">En stock: {{ ing.stock.quantite }} {{ ing.unite }}</p>
                {% else %}
                <p class="ingredient-stock-vide">Pas en stock</p>
                {% endif %}
            </div>
            <div class="ingredient-actions">
                <a href="{{ url_for('ingredients.modifier', id=ing.id) }}" class="btn btn-small">Modifier</a>
                <a href="{{ url_for('ingredients.supprimer', id=ing.id) }}" 
                   class="btn btn-danger btn-small" 
                   onclick="return confirm('Supprimer cet ingr√©dient ?')">
                    Supprimer
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p>Aucun ingr√©dient trouv√©. 
        {% if search_query or categorie_filter or stock_filter %}
        Essayez de modifier vos crit√®res de recherche.
        {% else %}
        Utilisez le formulaire ci-dessus pour en ajouter !
        {% endif %}
    </p>
    {% endif %}
</div>
{% endblock %}
