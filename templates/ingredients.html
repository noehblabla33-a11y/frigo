{% extends "base.html" %}
{% from "macros/pagination.html" import render_pagination %}
{% from "macros/search_filters.html" import render_search_form, render_empty_state %}
{% from "macros/forms.html" import input_field, select_field, select_categories, file_field, submit_button, nutrition_fields %}
{% block title %}Catalogue des ingr√©dients{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='style/pagination.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style/collapsable.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style/ingredients.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style/search-filters.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style/forms.css') }}">
{% endblock %}

{% block content %}
<script>document.body.dataset.page = 'ingredients';</script>

{# ============================================ #}
{# FORMULAIRE DE RECHERCHE (FACTORIS√â)         #}
{# ============================================ #}
{% set category_options = [] %}
{% for cat_name, cat_icon in categories %}
    {% set count = categories_count.get(cat_name, 0) %}
    {% set _ = category_options.append({
        'value': cat_name,
        'text': cat_icon ~ ' ' ~ cat_name,
        'count': count if count > 0 else none
    }) %}
{% endfor %}

{% set stock_options = [
    ('en_stock', 'En stock'),
    ('pas_en_stock', 'Pas en stock')
] %}

{% set filters = [
    {
        'name': 'categorie',
        'label': 'Cat√©gorie',
        'type': 'select',
        'searchable': true,
        'placeholder': 'Toutes les cat√©gories',
        'options': category_options,
        'selected': categorie_filter
    },
    {
        'name': 'stock',
        'label': 'Stock',
        'type': 'select_simple',
        'placeholder': 'Tous',
        'options': stock_options,
        'selected': stock_filter
    }
] %}

{% set active_filters = {} %}
{% if categorie_filter %}
    {% set _ = active_filters.update({'categorie': {'label': 'Cat√©gorie', 'value': categorie_filter}}) %}
{% endif %}
{% if stock_filter == 'en_stock' %}
    {% set _ = active_filters.update({'stock': {'label': 'Stock', 'value': stock_filter, 'display': 'En stock uniquement'}}) %}
{% elif stock_filter == 'pas_en_stock' %}
    {% set _ = active_filters.update({'stock': {'label': 'Stock', 'value': stock_filter, 'display': 'Pas en stock'}}) %}
{% endif %}

{{ render_search_form(
    endpoint='ingredients.liste',
    search_value=search_query,
    search_placeholder='Ex: Tomate, Oignon...',
    filters=filters,
    active_filters=active_filters
) }}

{# Afficher le nombre de r√©sultats si filtres actifs #}
{% if (search_query or categorie_filter or stock_filter) and pagination.total is defined %}
<div style="margin: -10px 0 20px 0; padding-left: 5px;">
    <span style="color: var(--text-secondary);">{{ pagination.total }} r√©sultat(s)</span>
</div>
{% endif %}

{# ============================================ #}
{# FORMULAIRE D'AJOUT (COLLAPSABLE + MACROS)   #}
{# ============================================ #}
<div class="card">
    <h3 data-collapsable="add-form" class="collapsable-header">
        ‚ûï Ajouter un ingr√©dient
    </h3>
    <div id="add-form" class="collapsable-content">
        <form method="POST" enctype="multipart/form-data">
            {# Ligne 1 : Nom, Unit√©, Prix #}
            <div class="form-row">
                {{ input_field('nom', label='Nom de l\'ingr√©dient', 
                              placeholder='Ex: Tomates cerises', required=true, flex=2) }}

                {{ select_categories('categorie', categories, placeholder='Aucune') }}
                
                {{ input_field('prix_unitaire', label='Prix unitaire (‚Ç¨)', type='number',
                              placeholder='0.00', step='0.001', min=0, 
                              attrs={'id': 'prix-unitaire-input'}, flex=1) }}
            </div>
            
            <div class="form-row">
                {% set unite_options = [
                    ('g', 'Grammes (g)'),
                    ('ml', 'Millilitres (ml)'),
                    ('pi√®ce', 'Pi√®ce')
                ] %}
                {{ select_field('unite', label='Unit√©', options=unite_options, 
                               attrs={'id': 'unite-select'}, flex=1) }}
                
                {{ input_field('poids_piece', label='Poids par pi√®ce (g)', type='number',
                              placeholder='Si unit√© = pi√®ce', step='0.1', min=0,
                              help_text='Pour les ingr√©dients compt√©s en pi√®ces',
                              attrs={'id': 'poids-piece-input'}, flex=1) }}
                
                {{ file_field('image', label='Image', flex=1) }}
            </div>
            
            {{ nutrition_fields() }}
            
            <div style="margin-top: 20px;">
                {{ submit_button(text='Ajouter l\'ingr√©dient', icon='‚úì', variant='success') }}
            </div>
        </form>
    </div>
</div>

{# ============================================ #}
{# LISTE DES INGR√âDIENTS                       #}
{# ============================================ #}
<div class="card">
    <div class="catalogue-header">
        <h3>üì¶ Catalogue des ingr√©dients</h3>
    </div>
    
    <p style="margin-bottom: 20px;">
        Voici tous les ingr√©dients disponibles dans votre catalogue.
        {% if pagination.total > 0 %}
        <strong>{{ pagination.total }}</strong> ingr√©dient(s) au total.
        {% endif %}
    </p>
    
    {% if ingredients %}
        <div class="item-list">
            <table class="item-table">
                <thead>
                    <tr>
                        <th style="width: 60px;"></th>
                        <th>Nom</th>
                        <th>Cat√©gorie</th>
                        <th>Unit√©</th>
                        <th>Prix (en kg/L)</th>
                        <th style="text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ing in ingredients %}
                    <tr>
                        <td class="item-img-cell">
                            {% if ing.image %}
                            <img src="{{ url_for('static', filename=ing.image) }}" 
                                alt="{{ ing.nom }}" 
                                class="item-thumbnail"
                                loading="lazy">
                            {% else %}
                            <div class="item-thumbnail-placeholder">üì¶</div>
                            {% endif %}
                        </td>
                        <td class="item-name-cell">
                            <strong>{{ ing.nom }}</strong>
                        </td>
                        <td>
                            {% if ing.categorie %}
                            <span class="category-badge-small badge">
                                {% for cat_name, cat_icon in categories %}
                                    {% if cat_name == ing.categorie %}
                                        {{ cat_icon }} {{ cat_name }}
                                    {% endif %}
                                {% endfor %}
                            </span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>{{ ing.unite }}</td>
                        <td>
                            {{ ing.prix_unitaire|prix_lisible(ing.unite, ing) }}
                        </td>
                        <td class="actions-cell">
                            <a href="{{ url_for('ingredients.modifier', id=ing.id) }}" 
                               class="btn-icon" 
                               title="Modifier">‚úèÔ∏è</a>
                            <a href="{{ url_for('ingredients.supprimer', id=ing.id) }}" 
                               class="btn-icon btn-icon-danger" 
                               title="Supprimer"
                               data-confirm="Supprimer l'ingr√©dient ¬´ {{ ing.nom }} ¬ª ?">üóëÔ∏è</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {# Pagination #}
        {{ render_pagination(pagination, 'ingredients.liste',
                           search=search_query,
                           categorie=categorie_filter,
                           stock=stock_filter) }}
    {% else %}
        {{ render_empty_state(
            icon='üì¶',
            message='Aucun ingr√©dient trouv√©.',
            has_filters=(search_query or categorie_filter or stock_filter),
            filter_message='Essayez de modifier vos crit√®res de recherche.',
            add_message='Utilisez le formulaire ci-dessus pour en ajouter !'
        ) }}
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='javascript/collapsable.js') }}"></script>
<script src="{{ url_for('static', filename='javascript/price-helper.js') }}"></script>
{% endblock %}
