{% extends "base.html" %}
{% block title %}Modifier {{ recette.nom }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='style/recettes.css') }}">
{% endblock %}

{% block content %}
<div class="card">
    <h3>‚úèÔ∏è Modifier la recette</h3>
    <form method="POST" id="recetteForm" enctype="multipart/form-data">
        <div class="form-group">
            <label>Nom de la recette</label>
            <input type="text" name="nom" value="{{ recette.nom }}" required>
        </div>
        
        <div class="form-group">
            <label>Type de recette</label>
            <select name="type_recette" class="searchable-select">
                <option value="">S√©lectionner un type (optionnel)</option>
                {% for type in types_recettes %}
                <option value="{{ type }}" {% if recette.type_recette == type %}selected{% endif %}>
                    {{ type }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        {# ‚úÖ NOUVEAU : Temps s√©par√©s (pr√©paration + cuisson) #}
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div class="form-group">
                <label>‚è±Ô∏è Temps de pr√©paration (minutes)</label>
                <input type="number" 
                       name="temps_preparation" 
                       value="{{ recette.temps_preparation if recette.temps_preparation else '' }}"
                       placeholder="Ex: 20"
                       min="0">
                <small style="color: #6c757d; font-size: 0.85em; display: block; margin-top: 5px;">
                    Temps actif de pr√©paration
                </small>
            </div>
            
            <div class="form-group">
                <label>üî• Temps de cuisson (minutes)</label>
                <input type="number" 
                       name="temps_cuisson" 
                       value="{{ recette.temps_cuisson if recette.temps_cuisson else '' }}"
                       placeholder="Ex: 30"
                       min="0">
                <small style="color: #6c757d; font-size: 0.85em; display: block; margin-top: 5px;">
                    Temps de cuisson (four, plaque, etc.)
                </small>
            </div>
        </div>
        
        {# Affichage du temps total (si d√©fini) #}
        {% if recette.temps_total() %}
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: 600;">
            ‚è∞ Temps total actuel : {{ recette.temps_total() }} minutes
        </div>
        {% endif %}
        
        <div class="form-group">
            <label>Image de la recette</label>
            {% if recette.image %}
            <div style="margin-bottom: 10px;">
                <img src="{{ url_for('static', filename=recette.image|image_path) }}"
                     alt="{{ recette.nom }}" 
                     style="max-width: 200px; border-radius: 8px;">
                <p style="color: #6c757d; font-size: 0.9em; margin-top: 5px;">
                    Image actuelle (choisissez un nouveau fichier pour la remplacer)
                </p>
            </div>
            {% endif %}
            <input type="file" name="image" accept="image/*">
        </div>
        
        <!-- Ingr√©dients -->
        <div class="form-group">
            <label>Ingr√©dients</label>
            <p style="color: #6c757d; font-size: 0.9em; margin-bottom: 15px;">
                G√©rez les ingr√©dients de votre recette. Vous pouvez modifier les quantit√©s, supprimer ou ajouter des ingr√©dients.
            </p>
            
            <div id="ingredients-container">
                {% if recette.ingredients %}
                {% for ing_rec in recette.ingredients %}
                <div class="ingredient-row" data-ingredient-row="{{ loop.index0 }}">
                    <div class="form-group" style="flex: 2;">
                        <select name="ingredient_{{ loop.index0 }}" class="ingredient-select searchable-select" required>
                            <option value="">S√©lectionner...</option>
                            {% for ing in ingredients %}
                            <option value="{{ ing.id }}" 
                                    data-unite="{{ ing.unite }}"
                                    {% if ing.id == ing_rec.ingredient_id %}selected{% endif %}>
                                {{ ing.nom }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group" style="flex: 1;">
                        <input type="number" 
                               step="1" 
                               name="quantite_{{ loop.index0 }}" 
                               value="{{ ing_rec.quantite|int if ing_rec.quantite == ing_rec.quantite|int else ing_rec.quantite }}"
                               placeholder="Quantit√©"
                               required>
                    </div>
                    
                    <div class="form-group" style="flex: 0.5;">
                        <input type="text" 
                               class="unite-display" 
                               value="{{ ing_rec.ingredient.unite }}" 
                               readonly 
                               style="background: #f0f0f0; cursor: not-allowed; text-align: center; font-weight: 600;">
                    </div>
                    
                    <div class="form-group" style="flex: 0;">
                        <button type="button" 
                                class="btn-remove-ingredient" 
                                onclick="removeIngredient({{ loop.index0 }})"
                                {% if loop.first %}style="display: none;"{% endif %}>
                            ‚úñ
                        </button>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="ingredient-row" data-ingredient-row="0">
                    <div class="form-group" style="flex: 2;">
                        <select name="ingredient_0" class="ingredient-select searchable-select" required>
                            <option value="">S√©lectionner...</option>
                            {% for ing in ingredients %}
                            <option value="{{ ing.id }}" data-unite="{{ ing.unite }}">
                                {{ ing.nom }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group" style="flex: 1;">
                        <input type="number" 
                               step="1" 
                               name="quantite_0" 
                               placeholder="Quantit√©"
                               required>
                    </div>
                    
                    <div class="form-group" style="flex: 0.5;">
                        <input type="text" 
                               class="unite-display" 
                               value="g" 
                               readonly 
                               style="background: #f0f0f0; cursor: not-allowed; text-align: center; font-weight: 600;">
                    </div>
                    
                    <div class="form-group" style="flex: 0;">
                        <button type="button" 
                                class="btn-remove-ingredient" 
                                onclick="removeIngredient(0)"
                                style="display: none;">
                            ‚úñ
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <button type="button" onclick="ajouterIngredient()" class="btn" style="margin-top: 10px;">
                + Ajouter un ingr√©dient
            </button>
        </div>
        
        <!-- √âtapes de pr√©paration -->
        <div class="form-group">
            <label>√âtapes de pr√©paration</label>
            <p style="color: #6c757d; font-size: 0.9em; margin-bottom: 15px;">
                D√©crivez les √©tapes une par une. Vous pouvez ajouter un minuteur optionnel pour chaque √©tape.
            </p>
            
            <div id="etapes-container">
                {% if recette.etapes %}
                {% for etape in recette.etapes %}
                <div class="etape-row" data-etape="{{ loop.index0 }}">
                    <div class="etape-number">{{ loop.index }}</div>
                    <div class="etape-inputs">
                        <div class="form-group" style="flex: 3; margin-bottom: 0;">
                            <textarea name="etape_desc_{{ loop.index0 }}" 
                                    placeholder="D√©crivez cette √©tape..."
                                    rows="2">{{ etape.description }}</textarea>
                        </div>
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <input type="number" 
                                   name="etape_duree_{{ loop.index0 }}" 
                                   value="{{ etape.duree_minutes if etape.duree_minutes else '' }}"
                                   placeholder="‚è±Ô∏è Minutes (opt.)"
                                   min="0">
                        </div>
                    </div>
                    <button type="button" 
                            class="btn-remove-etape" 
                            onclick="removeEtape({{ loop.index0 }})"
                            {% if loop.first %}style="display: none;"{% endif %}>
                        ‚úñ
                    </button>
                </div>
                {% endfor %}
                {% else %}
                <div class="etape-row" data-etape="0">
                    <div class="etape-number">1</div>
                    <div class="etape-inputs">
                        <div class="form-group" style="flex: 3; margin-bottom: 0;">
                            <textarea name="etape_desc_0" 
                                    placeholder="D√©crivez cette √©tape..."
                                    rows="2"></textarea>
                        </div>
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <input type="number" 
                                   name="etape_duree_0" 
                                   placeholder="‚è±Ô∏è Minutes (opt.)"
                                   min="0">
                        </div>
                    </div>
                    <button type="button" 
                            class="btn-remove-etape" 
                            onclick="removeEtape(0)"
                            style="display: none;">
                        ‚úñ
                    </button>
                </div>
                {% endif %}
            </div>
            
            <button type="button" onclick="ajouterEtape()" class="btn" style="margin-top: 10px;">
                + Ajouter une √©tape
            </button>
        </div>
        
        <div class="form-actions">
            <a href="{{ url_for('recettes.detail', id=recette.id) }}" class="btn btn-secondary">
                Annuler
            </a>
            <button type="submit" class="btn btn-primary">
                ‚úì Enregistrer les modifications
            </button>
        </div>
    </form>
</div>

{# Informations nutritionnelles (si disponibles) #}
{% set nutrition = recette.calculer_nutrition() %}
{% if nutrition.calories or nutrition.proteines or nutrition.glucides or nutrition.lipides %}
<div class="card" style="margin-top: 20px;">
    <h3>üìä Valeurs nutritionnelles estim√©es</h3>
    <div class="nutrition-grid">
        {% if nutrition.calories %}
        <div class="nutrition-item">
            <span class="nutrition-label">Calories</span>
            <span class="nutrition-value">{{ nutrition.calories|round(1) }} kcal</span>
        </div>
        {% endif %}
        {% if nutrition.proteines %}
        <div class="nutrition-item">
            <span class="nutrition-label">Prot√©ines</span>
            <span class="nutrition-value">{{ nutrition.proteines|round(1) }} g</span>
        </div>
        {% endif %}
        {% if nutrition.glucides %}
        <div class="nutrition-item">
            <span class="nutrition-label">Glucides</span>
            <span class="nutrition-value">{{ nutrition.glucides|round(1) }} g</span>
        </div>
        {% endif %}
        {% if nutrition.lipides %}
        <div class="nutrition-item">
            <span class="nutrition-label">Lipides</span>
            <span class="nutrition-value">{{ nutrition.lipides|round(1) }} g</span>
        </div>
        {% endif %}
    </div>
    <p style="color: #6c757d; font-size: 0.85em; margin-top: 15px;">
        üí° Ces valeurs sont calcul√©es automatiquement √† partir des ingr√©dients. 
        Ajoutez les valeurs nutritionnelles aux ingr√©dients.
    </p>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='javascript/ingredient-units.js') }}"></script>
<script>
(function() {
    'use strict';
    
    // =============================================
    // COMPTEURS - Initialis√©s avec les donn√©es existantes
    // =============================================
    {% if recette.ingredients %}
    let ingredientCount = {{ recette.ingredients|length }};
    {% else %}
    let ingredientCount = 1;
    {% endif %}
    
    {% if recette.etapes %}
    let etapeCount = {{ recette.etapes|length }};
    {% else %}
    let etapeCount = 1;
    {% endif %}
    
    // =============================================
    // GESTION DES INGR√âDIENTS
    // =============================================
    
    function updateUniteDisplay(selectElement) {
        const row = selectElement.closest('.ingredient-row');
        if (!row) return;
        
        const uniteDisplay = row.querySelector('.unite-display');
        if (!uniteDisplay) return;
        
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        if (selectedOption && selectedOption.value) {
            uniteDisplay.value = selectedOption.dataset.unite || 'g';
        } else {
            uniteDisplay.value = 'g';
        }
    }
    
    window.ajouterIngredient = function() {
        const container = document.getElementById('ingredients-container');
        if (!container) return;
        
        const div = document.createElement('div');
        div.className = 'ingredient-row';
        div.dataset.ingredientRow = ingredientCount;
        div.innerHTML = `
            <div class="form-group" style="flex: 2;">
                <select name="ingredient_${ingredientCount}" class="ingredient-select searchable-select" required>
                    <option value="">S√©lectionner...</option>
                    {% for ing in ingredients %}
                    <option value="{{ ing.id }}" data-unite="{{ ing.unite }}">
                        {{ ing.nom }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group" style="flex: 1;">
                <input type="number" 
                       step="1" 
                       name="quantite_${ingredientCount}" 
                       placeholder="Quantit√©"
                       required>
            </div>
            
            <div class="form-group" style="flex: 0.5;">
                <input type="text" 
                       class="unite-display" 
                       value="g" 
                       readonly 
                       style="background: #f0f0f0; cursor: not-allowed; text-align: center; font-weight: 600;">
            </div>
            
            <div class="form-group" style="flex: 0;">
                <button type="button" 
                        class="btn-remove-ingredient" 
                        onclick="removeIngredient(${ingredientCount})">
                    ‚úñ
                </button>
            </div>
        `;
        
        container.appendChild(div);
        
        const select = div.querySelector('.ingredient-select');
        select.addEventListener('change', function() {
            updateUniteDisplay(this);
        });
        
        ingredientCount++;
        updateRemoveButtons();
    };
    
    window.removeIngredient = function(index) {
        const row = document.querySelector(`.ingredient-row[data-ingredient-row="${index}"]`);
        if (row) {
            row.remove();
        }
        updateRemoveButtons();
    };
    
    function updateRemoveButtons() {
        const rows = document.querySelectorAll('.ingredient-row');
        rows.forEach((row, index) => {
            const btn = row.querySelector('.btn-remove-ingredient');
            if (btn) {
                btn.style.display = rows.length > 1 ? 'block' : 'none';
            }
        });
    }
    
    // =============================================
    // GESTION DES √âTAPES
    // =============================================
    
    window.ajouterEtape = function() {
        const container = document.getElementById('etapes-container');
        if (!container) return;
        
        const div = document.createElement('div');
        div.className = 'etape-row';
        div.dataset.etape = etapeCount;
        div.innerHTML = `
            <div class="etape-number">${etapeCount + 1}</div>
            <div class="etape-inputs">
                <div class="form-group" style="flex: 3; margin-bottom: 0;">
                    <textarea name="etape_desc_${etapeCount}" 
                            placeholder="D√©crivez cette √©tape..."
                            rows="2"></textarea>
                </div>
                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                    <input type="number" 
                           name="etape_duree_${etapeCount}" 
                           placeholder="‚è±Ô∏è Minutes (opt.)"
                           min="0">
                </div>
            </div>
            <button type="button" 
                    class="btn-remove-etape" 
                    onclick="removeEtape(${etapeCount})">
                ‚úñ
            </button>
        `;
        
        container.appendChild(div);
        etapeCount++;
        updateEtapeNumbers();
    };
    
    window.removeEtape = function(index) {
        const row = document.querySelector(`.etape-row[data-etape="${index}"]`);
        if (row) {
            row.remove();
        }
        updateEtapeNumbers();
    };
    
    function updateEtapeNumbers() {
        const rows = document.querySelectorAll('.etape-row');
        rows.forEach((row, index) => {
            const numberDiv = row.querySelector('.etape-number');
            if (numberDiv) {
                numberDiv.textContent = index + 1;
            }
            const btn = row.querySelector('.btn-remove-etape');
            if (btn) {
                btn.style.display = rows.length > 1 ? 'block' : 'none';
            }
        });
    }
    
    // =============================================
    // INITIALISATION
    // =============================================
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialiser les selects d'ingr√©dients existants
        document.querySelectorAll('.ingredient-select').forEach(select => {
            select.addEventListener('change', function() {
                updateUniteDisplay(this);
            });
            updateUniteDisplay(select);
        });
        
        updateRemoveButtons();
        updateEtapeNumbers();
    });
})();
</script>
{% endblock %}
