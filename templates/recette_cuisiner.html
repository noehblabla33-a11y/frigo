{% extends "base.html" %}
{% block title %}üç≥ Cuisiner : {{ recette.nom }}{% endblock %}

{% block content %}
<div class="cooking-mode-header">
    <div class="cooking-title">
        <h2>üç≥ {{ recette.nom }}</h2>
        <p>Mode cuisson avec minuteurs interactifs</p>
    </div>
    <div class="cooking-actions">
        <a href="{{ url_for('recettes.detail', id=recette.id) }}" class="btn btn-secondary">‚Üê Retour</a>
        <button onclick="reinitialiser()" class="btn">üîÑ R√©initialiser</button>
    </div>
</div>

<!-- Ingr√©dients n√©cessaires (collapsible) -->
<div class="card cooking-card">
    <div class="collapsible-header" onclick="toggleSection('ingredients')">
        <h3>ü•ó Ingr√©dients n√©cessaires</h3>
        <span class="toggle-icon" id="toggle-ingredients">‚ñº</span>
    </div>
    <div class="collapsible-content" id="content-ingredients">
        <div class="ingredients-checklist">
            {% for ing_rec in recette.ingredients %}
            <label class="ingredient-check-item">
                <input type="checkbox" class="ingredient-checkbox">
                <span class="ingredient-check-text">
                    <strong>{{ ing_rec.ingredient.nom }}</strong> : 
                    {{ ing_rec.quantite }} {{ ing_rec.ingredient.unite }}
                </span>
            </label>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Progression globale -->
<div class="card cooking-card">
    <div class="progress-container">
        <div class="progress-info">
            <span>Progression</span>
            <span id="progress-text">0 / {{ recette.etapes|length }}</span>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar" id="global-progress" style="width: 0%;"></div>
        </div>
    </div>
</div>

<!-- √âtapes de la recette -->
<div class="etapes-container">
    {% for etape in recette.etapes %}
    <div class="etape-card" id="etape-{{ etape.id }}" data-etape-id="{{ etape.id }}">
        <div class="etape-header">
            <div class="etape-numero">√âtape {{ etape.ordre }}</div>
            <div class="etape-status" id="status-{{ etape.id }}">
                <span class="status-badge status-pending">En attente</span>
            </div>
        </div>
        
        <div class="etape-content">
            <p class="etape-description">{{ etape.description }}</p>
            
            {% if etape.duree_minutes %}
            <div class="timer-section" id="timer-section-{{ etape.id }}">
                <div class="timer-display" id="timer-display-{{ etape.id }}">
                    <span class="timer-icon">‚è±Ô∏è</span>
                    <span class="timer-time" id="timer-time-{{ etape.id }}">
                        {{ '%02d'|format(etape.duree_minutes) }}:00
                    </span>
                </div>
                <div class="timer-controls">
                    <button class="timer-btn timer-start" 
                            onclick="startTimer({{ etape.id }}, {{ etape.duree_minutes }})"
                            id="start-{{ etape.id }}">
                        ‚ñ∂Ô∏è D√©marrer
                    </button>
                    <button class="timer-btn timer-pause" 
                            onclick="pauseTimer({{ etape.id }})"
                            id="pause-{{ etape.id }}"
                            style="display: none;">
                        ‚è∏Ô∏è Pause
                    </button>
                    <button class="timer-btn timer-resume" 
                            onclick="resumeTimer({{ etape.id }})"
                            id="resume-{{ etape.id }}"
                            style="display: none;">
                        ‚ñ∂Ô∏è Reprendre
                    </button>
                    <button class="timer-btn timer-reset" 
                            onclick="resetTimer({{ etape.id }}, {{ etape.duree_minutes }})"
                            id="reset-{{ etape.id }}">
                        üîÑ Reset
                    </button>
                </div>
                <div class="timer-progress-bar">
                    <div class="timer-progress-fill" id="progress-{{ etape.id }}"></div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="etape-actions">
            <button class="btn btn-success" onclick="completeStep({{ etape.id }})">
                ‚úì √âtape termin√©e
            </button>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Audio pour l'alarme (√† placer dans static/sounds/timer-alert.mp3) -->
<audio id="timer-alarm" preload="auto">
    <source src="{{ url_for('static', filename='sounds/timer-alert.mp3') }}" type="audio/mpeg">
    <source src="{{ url_for('static', filename='sounds/timer-alert.ogg') }}" type="audio/ogg">
    <source src="{{ url_for('static', filename='sounds/timer-alert.wav') }}" type="audio/wav">
</audio>

<script>
// √âtat global des minuteurs
const timers = {};
const completedSteps = new Set();

// Initialiser les minuteurs
{% for etape in recette.etapes %}
{% if etape.duree_minutes %}
timers[{{ etape.id }}] = {
    duration: {{ etape.duree_minutes }} * 60,
    remaining: {{ etape.duree_minutes }} * 60,
    interval: null,
    isPaused: false
};
{% endif %}
{% endfor %}

function startTimer(etapeId, minutes) {
    if (timers[etapeId].interval) return; // D√©j√† d√©marr√©
    
    document.getElementById(`start-${etapeId}`).style.display = 'none';
    document.getElementById(`pause-${etapeId}`).style.display = 'inline-block';
    
    const statusBadge = document.querySelector(`#status-${etapeId} .status-badge`);
    statusBadge.className = 'status-badge status-in-progress';
    statusBadge.textContent = 'En cours';
    
    timers[etapeId].interval = setInterval(() => {
        if (!timers[etapeId].isPaused) {
            timers[etapeId].remaining--;
            
            const mins = Math.floor(timers[etapeId].remaining / 60);
            const secs = timers[etapeId].remaining % 60;
            
            document.getElementById(`timer-time-${etapeId}`).textContent = 
                `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            
            // Barre de progression
            const progress = ((timers[etapeId].duration - timers[etapeId].remaining) / timers[etapeId].duration) * 100;
            document.getElementById(`progress-${etapeId}`).style.width = progress + '%';
            
            // Changement de couleur selon le temps restant
            const timerDisplay = document.getElementById(`timer-display-${etapeId}`);
            if (timers[etapeId].remaining <= 10) {
                timerDisplay.classList.add('timer-critical');
            } else if (timers[etapeId].remaining <= 60) {
                timerDisplay.classList.add('timer-warning');
            }
            
            // Timer termin√©
            if (timers[etapeId].remaining <= 0) {
                clearInterval(timers[etapeId].interval);
                timers[etapeId].interval = null;
                
                timerDisplay.classList.add('timer-finished');
                document.getElementById(`pause-${etapeId}`).style.display = 'none';
                document.getElementById(`start-${etapeId}`).style.display = 'none';
                
                // Jouer le son d'alarme
                playAlarm();
                
                // Notification visuelle
                showNotification(`‚è∞ Timer termin√© pour l'√©tape ${getEtapeOrdre(etapeId)} !`);
                
                // Animation de la carte
                const card = document.getElementById(`etape-${etapeId}`);
                card.classList.add('etape-timer-finished');
            }
        }
    }, 1000);
}

function pauseTimer(etapeId) {
    timers[etapeId].isPaused = true;
    document.getElementById(`pause-${etapeId}`).style.display = 'none';
    document.getElementById(`resume-${etapeId}`).style.display = 'inline-block';
}

function resumeTimer(etapeId) {
    timers[etapeId].isPaused = false;
    document.getElementById(`resume-${etapeId}`).style.display = 'none';
    document.getElementById(`pause-${etapeId}`).style.display = 'inline-block';
}

function resetTimer(etapeId, minutes) {
    if (timers[etapeId].interval) {
        clearInterval(timers[etapeId].interval);
        timers[etapeId].interval = null;
    }
    
    timers[etapeId].remaining = minutes * 60;
    timers[etapeId].isPaused = false;
    
    document.getElementById(`timer-time-${etapeId}`).textContent = 
        `${String(minutes).padStart(2, '0')}:00`;
    document.getElementById(`progress-${etapeId}`).style.width = '0%';
    
    document.getElementById(`start-${etapeId}`).style.display = 'inline-block';
    document.getElementById(`pause-${etapeId}`).style.display = 'none';
    document.getElementById(`resume-${etapeId}`).style.display = 'none';
    
    const timerDisplay = document.getElementById(`timer-display-${etapeId}`);
    timerDisplay.classList.remove('timer-warning', 'timer-critical', 'timer-finished');
    
    const card = document.getElementById(`etape-${etapeId}`);
    card.classList.remove('etape-timer-finished');
}

function completeStep(etapeId) {
    // Arr√™ter le timer s'il est actif
    if (timers[etapeId] && timers[etapeId].interval) {
        clearInterval(timers[etapeId].interval);
        timers[etapeId].interval = null;
    }
    
    completedSteps.add(etapeId);
    
    const statusBadge = document.querySelector(`#status-${etapeId} .status-badge`);
    statusBadge.className = 'status-badge status-completed';
    statusBadge.textContent = '‚úì Termin√©e';
    
    const card = document.getElementById(`etape-${etapeId}`);
    card.classList.add('etape-completed');
    
    updateGlobalProgress();
    
    // Faire d√©filer jusqu'√† la prochaine √©tape
    scrollToNextStep(etapeId);
}

function updateGlobalProgress() {
    const total = {{ recette.etapes|length }};
    const completed = completedSteps.size;
    const percentage = (completed / total) * 100;
    
    document.getElementById('progress-text').textContent = `${completed} / ${total}`;
    document.getElementById('global-progress').style.width = percentage + '%';
    
    if (completed === total) {
        showNotification('üéâ F√©licitations ! Toutes les √©tapes sont termin√©es !');
    }
}

function scrollToNextStep(currentEtapeId) {
    const allEtapes = document.querySelectorAll('.etape-card');
    let foundCurrent = false;
    
    for (let etape of allEtapes) {
        if (foundCurrent && !completedSteps.has(parseInt(etape.dataset.etapeId))) {
            etape.scrollIntoView({ behavior: 'smooth', block: 'center' });
            break;
        }
        if (parseInt(etape.dataset.etapeId) === currentEtapeId) {
            foundCurrent = true;
        }
    }
}

function getEtapeOrdre(etapeId) {
    const card = document.getElementById(`etape-${etapeId}`);
    return card.querySelector('.etape-numero').textContent;
}

function playAlarm() {
    const alarm = document.getElementById('timer-alarm');
    alarm.currentTime = 0;
    alarm.play().catch(err => {
        console.log('Impossible de jouer le son:', err);
        // Fallback : utiliser l'API Web Notification si disponible
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('Timer termin√© !', {
                body: 'Une √©tape de votre recette est termin√©e.',
                icon: '/static/icon.png'
            });
        }
    });
}

function showNotification(message) {
    // Cr√©er une notification en haut de l'√©cran
    const notification = document.createElement('div');
    notification.className = 'cooking-notification';
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

function reinitialiser() {
    if (!confirm('Voulez-vous vraiment r√©initialiser toutes les √©tapes ?')) {
        return;
    }
    
    // Arr√™ter tous les timers
    for (let etapeId in timers) {
        if (timers[etapeId].interval) {
            clearInterval(timers[etapeId].interval);
        }
        resetTimer(parseInt(etapeId), timers[etapeId].duration / 60);
    }
    
    // R√©initialiser les √©tapes compl√©t√©es
    completedSteps.clear();
    
    document.querySelectorAll('.etape-card').forEach(card => {
        card.classList.remove('etape-completed', 'etape-timer-finished');
        const statusBadge = card.querySelector('.status-badge');
        statusBadge.className = 'status-badge status-pending';
        statusBadge.textContent = 'En attente';
    });
    
    // R√©initialiser les checkboxes
    document.querySelectorAll('.ingredient-checkbox').forEach(cb => cb.checked = false);
    
    updateGlobalProgress();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function toggleSection(sectionId) {
    const content = document.getElementById(`content-${sectionId}`);
    const icon = document.getElementById(`toggle-${sectionId}`);
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '‚ñº';
    } else {
        content.style.display = 'none';
        icon.textContent = '‚ñ∂';
    }
}

// Demander la permission pour les notifications
if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
}

// Emp√™cher la fermeture accidentelle de la page pendant la cuisson
window.addEventListener('beforeunload', (e) => {
    if (completedSteps.size > 0 && completedSteps.size < {{ recette.etapes|length }}) {
        e.preventDefault();
        e.returnValue = 'Vous avez des √©tapes en cours. Voulez-vous vraiment quitter ?';
    }
});
</script>
{% endblock %}
