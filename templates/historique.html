{% extends "base.html" %}
{% block title %}Historique{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ versioned_url_for('static', filename='style/historique.css') }}">
{% endblock %}

{% block content %}
<!-- Statistiques globales -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number">{{ stats.total }}</div>
        <div class="stat-label">Recettes pr√©par√©es</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.mois }}</div>
        <div class="stat-label">Ce mois-ci</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.semaine }}</div>
        <div class="stat-label">Cette semaine</div>
    </div>
    {% if stats.cout_moyen > 0 %}
    <div class="stat-card">
        <div class="stat-number">{{ "%.2f"|format(stats.cout_moyen) }}‚Ç¨</div>
        <div class="stat-label">Co√ªt moyen/recette</div>
    </div>
    {% endif %}
</div>

<!-- Statistiques de co√ªts p√©riodiques -->
{% if stats.cout_moyen_semaine > 0 or stats.cout_moyen_mois > 0 %}
<div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
    {% if stats.cout_moyen_semaine > 0 %}
    <div class="stat-card" style="background: linear-gradient(135deg, #20c997 0%, #17a589 100%);">
        <div class="stat-number">{{ "%.2f"|format(stats.cout_moyen_semaine) }}‚Ç¨</div>
        <div class="stat-label">Co√ªt moyen/recette cette semaine</div>
        <div style="font-size: 0.9em; opacity: 0.8; margin-top: 10px;">
            Total: {{ "%.2f"|format(stats.cout_total_semaine) }}‚Ç¨
        </div>
    </div>
    {% endif %}
    {% if stats.cout_moyen_mois > 0 %}
    <div class="stat-card" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
        <div class="stat-number">{{ "%.2f"|format(stats.cout_moyen_mois) }}‚Ç¨</div>
        <div class="stat-label">Co√ªt moyen/recette ce mois</div>
        <div style="font-size: 0.9em; opacity: 0.8; margin-top: 10px;">
            Total: {{ "%.2f"|format(stats.cout_total_mois) }}‚Ç¨
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Graphique des recettes par mois -->
<div class="card">
    <h3>üìä Recettes pr√©par√©es par mois</h3>
    <canvas id="chartMois" style="max-height: 300px;"></canvas>
</div>

<!-- Graphiques de co√ªts moyens par p√©riode -->
{% if couts_periodiques.semaines.labels|length > 0 or couts_periodiques.mois.labels|length > 0 %}
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin: 20px 0;">
    {% if couts_periodiques.semaines.labels|length > 0 %}
    <div class="card">
        <h3>üí∞ Co√ªt moyen par semaine</h3>
        <canvas id="chartCoutsSemaines" style="max-height: 300px;"></canvas>
        <p style="text-align: center; color: var(--text-secondary); margin-top: 10px; font-size: 0.9em;">
            √âvolution des co√ªts moyens par recette sur les derni√®res semaines
        </p>
    </div>
    {% endif %}
    
    {% if couts_periodiques.mois.labels|length > 0 %}
    <div class="card">
        <h3>üí∞ Co√ªt moyen par mois</h3>
        <canvas id="chartCoutsMois" style="max-height: 300px;"></canvas>
        <p style="text-align: center; color: var(--text-secondary); margin-top: 10px; font-size: 0.9em;">
            √âvolution des co√ªts moyens par recette sur les derniers mois
        </p>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Graphiques cat√©gories et ingr√©dients -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin: 20px 0;">
    <!-- Consommation par cat√©gorie -->
    {% if stats_categories.labels|length > 0 %}
    <div class="card">
        <h3>üè∑Ô∏è Consommation par cat√©gorie d'ingr√©dients</h3>
        <canvas id="chartCategories" style="max-height: 350px;"></canvas>
        {% if stats_categories.couts|sum > 0 %}
        <p style="text-align: center; color: var(--text-secondary); margin-top: 10px; font-size: 0.9em;">
            Co√ªt total estim√©: {{ "%.2f"|format(stats_categories.couts|sum) }}‚Ç¨
        </p>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Ingr√©dients les plus utilis√©s -->
    {% if ingredients_populaires.labels|length > 0 %}
    <div class="card">
        <h3>ü•ï Top 10 des ingr√©dients les plus utilis√©s</h3>
        <canvas id="chartIngredients" style="max-height: 350px;"></canvas>
    </div>
    {% endif %}
</div>

<!-- Top des recettes -->
<div class="card">
    <h3>üèÜ Top 10 des recettes les plus pr√©par√©es</h3>
    {% if top_recettes %}
    <div class="top-recettes">
        {% for recette in top_recettes %}
        <div class="top-recette-item">
            <span class="rank">
                {% if loop.index == 1 %}ü•á
                {% elif loop.index == 2 %}ü•à
                {% elif loop.index == 3 %}ü•â
                {% else %}{{ loop.index }}
                {% endif %}
            </span>
            <span class="recette-nom">{{ recette.nom }}</span>
            <span class="recette-count">{{ recette.nb_preparations }} fois</span>
        </div>
        {% endfor %}
    </div>
    <canvas id="chartTop" style="max-height: 300px; margin-top: 20px;"></canvas>
    {% else %}
    <p>Aucune recette pr√©par√©e pour le moment.</p>
    {% endif %}
</div>

<!-- Historique d√©taill√© -->
<div class="card">
    <h3>üìÖ Historique des pr√©parations</h3>
    {% if historique %}
    <div class="historique-liste">
        {% for prep in historique %}
        <div class="historique-item">
            <div class="historique-date">
                {{ prep.date_preparation.strftime('%d/%m/%Y √† %H:%M') if prep.date_preparation else 'Date inconnue' }}
            </div>
            <div class="historique-recette">
                <strong>{{ prep.recette_ref.nom }}</strong>
                {% set cout = prep.recette_ref.calculer_cout() %}
                {% if cout > 0 %}
                <span class="historique-cout">{{ cout }}‚Ç¨</span>
                {% endif %}
                {% if prep.recette_ref.ingredients %}
                <div class="historique-ingredients">
                    Ingr√©dients utilis√©s : 
                    {% for ing_rec in prep.recette_ref.ingredients[:3] %}
                        {{ ing_rec.ingredient.nom }}{% if not loop.last %}, {% endif %}
                    {% endfor %}
                    {% if prep.recette_ref.ingredients|length > 3 %}
                        et {{ prep.recette_ref.ingredients|length - 3 }} autre(s)
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p>Aucune recette pr√©par√©e pour le moment. Commencez √† cuisiner !</p>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{{ versioned_url_for('static', filename='javascript/historique.js') }}"></script>
<script>
    // Initialiser les graphiques avec les donn√©es du template
    document.addEventListener('DOMContentLoaded', () => {
        const graphiqueMois = {
            labels: {{ graphique_mois.labels|tojson }},
            data: {{ graphique_mois.data|tojson }}
        };
        
        const graphiqueTop = {
            labels: {{ graphique_top.labels|tojson }},
            data: {{ graphique_top.data|tojson }}
        };
        
        const statsCategories = {
            labels: {{ stats_categories.labels|tojson }},
            counts: {{ stats_categories.counts|tojson }},
            couts: {{ stats_categories.couts|tojson }}
        };
        
        const coutsPeriodiques = {
            semaines: {
                labels: {{ couts_periodiques.semaines.labels|tojson }},
                couts_moyens: {{ couts_periodiques.semaines.couts_moyens|tojson }},
                couts_totaux: {{ couts_periodiques.semaines.couts_totaux|tojson }}
            },
            mois: {
                labels: {{ couts_periodiques.mois.labels|tojson }},
                couts_moyens: {{ couts_periodiques.mois.couts_moyens|tojson }},
                couts_totaux: {{ couts_periodiques.mois.couts_totaux|tojson }}
            }
        };
        
        const ingredientsPopulaires = {
            labels: {{ ingredients_populaires.labels|tojson }},
            counts: {{ ingredients_populaires.counts|tojson }},
            quantites: {{ ingredients_populaires.quantites|tojson }},
            unites: {{ ingredients_populaires.unites|tojson }}
        };
        
        initHistoriqueCharts(graphiqueMois, graphiqueTop, statsCategories, coutsPeriodiques, ingredientsPopulaires);
    });
</script>
{% endblock %}
