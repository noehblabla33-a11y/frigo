{% extends "base.html" %}
{% block title %}Historique{% endblock %}

{% block content %}
<!-- Statistiques globales -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number">{{ stats.total }}</div>
        <div class="stat-label">Recettes pr√©par√©es</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.mois }}</div>
        <div class="stat-label">Ce mois-ci</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.semaine }}</div>
        <div class="stat-label">Cette semaine</div>
    </div>
    {% if stats.cout_moyen > 0 %}
    <div class="stat-card">
        <div class="stat-number">{{ "%.2f"|format(stats.cout_moyen) }}‚Ç¨</div>
        <div class="stat-label">Co√ªt moyen/recette</div>
    </div>
    {% endif %}
</div>

<!-- Graphique des recettes par mois -->
<div class="card">
    <h3>üìä Recettes pr√©par√©es par mois</h3>
    <canvas id="chartMois" style="max-height: 300px;"></canvas>
</div>

<!-- Top des recettes -->
<div class="card">
    <h3>üèÜ Top 10 des recettes les plus pr√©par√©es</h3>
    {% if top_recettes %}
    <div class="top-recettes">
        {% for recette in top_recettes %}
        <div class="top-recette-item">
            <span class="rank">
                {% if loop.index == 1 %}ü•á
                {% elif loop.index == 2 %}ü•à
                {% elif loop.index == 3 %}ü•â
                {% else %}{{ loop.index }}
                {% endif %}
            </span>
            <span class="recette-nom">{{ recette.nom }}</span>
            <span class="recette-count">{{ recette.nb_preparations }} fois</span>
        </div>
        {% endfor %}
    </div>
    <canvas id="chartTop" style="max-height: 300px; margin-top: 20px;"></canvas>
    {% else %}
    <p>Aucune recette pr√©par√©e pour le moment.</p>
    {% endif %}
</div>

<!-- Historique d√©taill√© -->
<div class="card">
    <h3>üìÖ Historique des pr√©parations</h3>
    {% if historique %}
    <div class="historique-liste">
        {% for prep in historique %}
        <div class="historique-item">
            <div class="historique-date">
                {{ prep.date_preparation.strftime('%d/%m/%Y √† %H:%M') if prep.date_preparation else 'Date inconnue' }}
            </div>
            <div class="historique-recette">
                <strong>{{ prep.recette_ref.nom }}</strong>
                {% set cout = prep.recette_ref.calculer_cout() %}
                {% if cout > 0 %}
                <span class="historique-cout">{{ cout }}‚Ç¨</span>
                {% endif %}
                {% if prep.recette_ref.ingredients %}
                <div class="historique-ingredients">
                    Ingr√©dients utilis√©s : 
                    {% for ing_rec in prep.recette_ref.ingredients[:3] %}
                        {{ ing_rec.ingredient.nom }}{% if not loop.last %}, {% endif %}
                    {% endfor %}
                    {% if prep.recette_ref.ingredients|length > 3 %}
                        et {{ prep.recette_ref.ingredients|length - 3 }} autre(s)
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p>Aucune recette pr√©par√©e pour le moment. Commencez √† cuisiner !</p>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{{ url_for('static', filename='javascript/historique.js') }}"></script>
<script>
    // Initialiser les graphiques avec les donn√©es du template
    document.addEventListener('DOMContentLoaded', () => {
        const graphiqueMois = {
            labels: {{ graphique_mois.labels|tojson }},
            data: {{ graphique_mois.data|tojson }}
        };
        
        const graphiqueTop = {
            labels: {{ graphique_top.labels|tojson }},
            data: {{ graphique_top.data|tojson }}
        };
        
        initHistoriqueCharts(graphiqueMois, graphiqueTop);
    });
</script>
{% endblock %}
