{% extends "base.html" %}
{% block title %}Que puis-je cuisiner ?{% endblock %}

{% block content %}
<div class="page-header">
    <h2>ü•ò Que puis-je cuisiner avec mon frigo ?</h2>
    <p>D√©couvrez les recettes que vous pouvez r√©aliser avec vos ingr√©dients en stock</p>
</div>

<!-- Statistiques rapides -->
<div class="stats-grid" style="margin-bottom: 30px;">
    <div class="stat-card">
        <div class="stat-number">{{ nb_realisables }}</div>
        <div class="stat-label">Recette(s) r√©alisable(s) maintenant</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ recettes_partielles|length }}</div>
        <div class="stat-label">Recette(s) partiellement possible(s)</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ planifiees|length }}</div>
        <div class="stat-label">Recette(s) planifi√©e(s)</div>
    </div>
</div>

<!-- Section des recettes planifi√©es -->
{% if planifiees %}
<div class="card">
    <h3>üìÖ Mes recettes planifi√©es</h3>
    <p style="color: #667eea; margin-bottom: 20px;">
        Recettes que vous avez planifi√©es et qui attendent d'√™tre pr√©par√©es
    </p>
    
    <div class="planifiees-container">
        {% for plan in planifiees %}
        <div class="recette-planifiee-card">
            <div class="planifiee-image">
                {% if plan.recette_ref.image %}
                <img src="{{ url_for('static', filename=plan.recette_ref.image.replace('static/', '')) }}" 
                     alt="{{ plan.recette_ref.nom }}"
                     loading="lazy">
                {% else %}
                <div class="no-image-small">üç≥</div>
                {% endif %}
            </div>
            
            <div class="planifiee-info">
                <h4>
                    <a href="{{ url_for('recettes.detail', id=plan.recette_ref.id) }}">
                        {{ plan.recette_ref.nom }}
                    </a>
                </h4>
                
                <div class="planifiee-meta">
                    {% if plan.recette_ref.type_recette %}
                    <span class="meta-badge">{{ plan.recette_ref.type_recette }}</span>
                    {% endif %}
                    <span class="meta-ingredients">{{ plan.recette_ref.ingredients|length }} ingr√©dient(s)</span>
                    {% if plan.recette_ref.temps_preparation %}
                    <span class="meta-temps">‚è±Ô∏è {{ plan.recette_ref.temps_preparation }} min</span>
                    {% endif %}
                </div>
                
                <!-- Statut des ingr√©dients -->
                <div class="ingredients-status">
                    {% set disponibilite = plan.recette_ref.calculer_disponibilite_ingredients() %}
                    {% if disponibilite.realisable %}
                    <span class="status-ready">‚úì Tous les ingr√©dients sont disponibles</span>
                    {% else %}
                    <span class="status-partial">
                        ‚ö†Ô∏è {{ disponibilite.ingredients_manquants|length }} ingr√©dient(s) manquant(s)
                    </span>
                    <ul class="ingredients-manquants">
                        {% for ing in disponibilite.ingredients_manquants[:3] %}
                        <li>{{ ing.ingredient.nom }}: {{ ing.quantite_manquante }} {{ ing.ingredient.unite }}</li>
                        {% endfor %}
                        {% if disponibilite.ingredients_manquants|length > 3 %}
                        <li>Et {{ disponibilite.ingredients_manquants|length - 3 }} autre(s)...</li>
                        {% endif %}
                    </ul>
                    {% endif %}
                </div>
            </div>
            
            <div class="planifiee-actions">
                <a href="{{ url_for('planification.preparer', id=plan.id) }}" 
                   class="btn btn-success btn-small">
                    ‚úì Marquer comme pr√©par√©e
                </a>
                <a href="{{ url_for('planification.annuler', id=plan.id) }}" 
                   class="btn btn-danger btn-small"
                   onclick="return confirm('Annuler cette planification ?')">
                    ‚úñ Annuler
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Recettes r√©alisables imm√©diatement -->
{% if recettes_realisables %}
<div class="card">
    <h3>‚úÖ Recettes r√©alisables imm√©diatement</h3>
    <p style="color: #28a745; margin-bottom: 20px;">
        Vous avez tous les ingr√©dients n√©cessaires pour ces recettes !
    </p>
    
    <div class="recettes-grid">
        {% for item in recettes_realisables %}
        {% set recette = item.recette %}
        <div class="recette-card">
            <a href="{{ url_for('recettes.detail', id=recette.id) }}" class="recette-link">
                <div class="recette-image">
                    {% if recette.image %}
                    <img src="{{ url_for('static', filename=recette.image.replace('static/', '')) }}" 
                         alt="{{ recette.nom }}"
                         loading="lazy">
                    {% else %}
                    <div class="no-image">üç≥</div>
                    {% endif %}
                    
                    <!-- Badge type √† GAUCHE -->
                    {% if recette.type_recette %}
                    <span class="recette-type-badge">{{ recette.type_recette }}</span>
                    {% endif %}
                    
                    <!-- Badge "R√©alisable" √† DROITE -->
                    <span class="badge-realisable">‚úì R√©alisable</span>
                </div>
                <div class="recette-info">
                    <h4>{{ recette.nom }}</h4>
                    <div class="recette-meta">
                        <span class="recette-ingredients-count">{{ recette.ingredients|length }} ingr√©dient(s)</span>
                        {% if recette.temps_preparation %}
                        <span class="recette-temps">‚è±Ô∏è {{ recette.temps_preparation }} min</span>
                        {% endif %}
                    </div>
                    
                    <!-- Barre de progression √† 100% -->
                    <div class="disponibilite-bar">
                        <div class="disponibilite-progress" style="width: 100%; background: #28a745;"></div>
                    </div>
                    <p class="disponibilite-text" style="color: #28a745;">
                        100% des ingr√©dients disponibles
                    </p>
                    
                    {% set cout = recette.calculer_cout() %}
                    {% if cout > 0 %}
                    <p class="recette-cout">‚âà {{ cout }}‚Ç¨</p>
                    {% endif %}
                </div>
            </a>
            <div class="recette-actions">
                <form method="POST" 
                      action="{{ url_for('recettes.planifier_rapide', id=recette.id) }}" 
                      style="display: inline;">
                    <button type="submit" 
                            class="btn btn-small"
                            style="background: #28a745; color: white;">
                        üìÖ Planifier
                    </button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Recettes partiellement r√©alisables -->
{% if recettes_partielles %}
<div class="card">
    <h3>üìä Recettes partiellement r√©alisables</h3>
    <p style="color: #6c757d; margin-bottom: 20px;">
        Tri√©es par pourcentage d'ingr√©dients disponibles
    </p>
    
    <div class="recettes-grid">
        {% for item in recettes_partielles[:12] %}
        {% set recette = item.recette %}
        {% set dispo = item.disponibilite %}
        <div class="recette-card">
            <a href="{{ url_for('recettes.detail', id=recette.id) }}" class="recette-link">
                <div class="recette-image">
                    {% if recette.image %}
                    <img src="{{ url_for('static', filename=recette.image.replace('static/', '')) }}" 
                         alt="{{ recette.nom }}"
                         loading="lazy">
                    {% else %}
                    <div class="no-image">üç≥</div>
                    {% endif %}
                    
                    {% if recette.type_recette %}
                    <span class="recette-type-badge">{{ recette.type_recette }}</span>
                    {% endif %}
                </div>
                <div class="recette-info">
                    <h4>{{ recette.nom }}</h4>
                    <div class="recette-meta">
                        <span class="recette-ingredients-count">{{ recette.ingredients|length }} ingr√©dient(s)</span>
                        {% if recette.temps_preparation %}
                        <span class="recette-temps">‚è±Ô∏è {{ recette.temps_preparation }} min</span>
                        {% endif %}
                    </div>
                    
                    <!-- Barre de progression -->
                    <div class="disponibilite-bar">
                        <div class="disponibilite-progress" 
                             style="width: {{ dispo.pourcentage }}%; 
                                    background: {% if dispo.pourcentage >= 75 %}#ffc107{% elif dispo.pourcentage >= 50 %}#ff9800{% else %}#f44336{% endif %};">
                        </div>
                    </div>
                    <p class="disponibilite-text" 
                       style="color: {% if dispo.pourcentage >= 75 %}#ffc107{% elif dispo.pourcentage >= 50 %}#ff9800{% else %}#f44336{% endif %};">
                        {{ dispo.pourcentage }}% des ingr√©dients disponibles
                        <br>
                        <small>{{ dispo.ingredients_manquants|length }} ingr√©dient(s) manquant(s)</small>
                    </p>
                    
                    {% set cout = recette.calculer_cout() %}
                    {% if cout > 0 %}
                    <p class="recette-cout">‚âà {{ cout }}‚Ç¨</p>
                    {% endif %}
                </div>
            </a>
            <div class="recette-actions">
                <form method="POST" 
                      action="{{ url_for('recettes.planifier_rapide', id=recette.id) }}" 
                      style="display: inline;">
                    <button type="submit" 
                            class="btn btn-small"
                            style="background: #667eea; color: white;">
                        üìÖ Planifier
                    </button>
                </form>
                <a href="{{ url_for('recettes.detail', id=recette.id) }}" 
                   class="btn btn-small"
                   style="background: #6c757d; color: white;">
                    Voir d√©tails
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    
    {% if recettes_partielles|length > 12 %}
    <p style="margin-top: 20px; text-align: center; color: #6c757d;">
        Et {{ recettes_partielles|length - 12 }} autre(s) recette(s)...
    </p>
    {% endif %}
</div>
{% endif %}

<!-- Message si aucune recette -->
{% if not recettes_realisables and not recettes_partielles %}
<div class="card">
    <p style="text-align: center; color: #6c757d; padding: 40px;">
        Aucune recette trouv√©e. Ajoutez des ingr√©dients √† votre frigo et cr√©ez des recettes !
    </p>
</div>
{% endif %}

<!-- Styles sp√©cifiques -->
<style>
/* Badge "R√©alisable" */
.badge-realisable {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #28a745;
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    z-index: 10;
}

/* Barres de disponibilit√© */
.disponibilite-bar {
    width: 100%;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin: 10px 0 5px 0;
}

.disponibilite-progress {
    height: 100%;
    transition: width 0.3s ease;
    border-radius: 4px;
}

.disponibilite-text {
    font-size: 0.9em;
    font-weight: 500;
    margin: 5px 0;
}

.disponibilite-text small {
    font-size: 0.85em;
    opacity: 0.8;
}

/* Section des recettes planifi√©es */
.planifiees-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.recette-planifiee-card {
    display: flex;
    gap: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
    border-left: 4px solid #667eea;
    align-items: center;
}

.planifiee-image {
    flex-shrink: 0;
    width: 120px;
    height: 120px;
    border-radius: 8px;
    overflow: hidden;
}

.planifiee-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.no-image-small {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-size: 3em;
}

.planifiee-info {
    flex: 1;
}

.planifiee-info h4 {
    margin: 0 0 10px 0;
}

.planifiee-info h4 a {
    color: #333;
    text-decoration: none;
}

.planifiee-info h4 a:hover {
    color: #667eea;
}

.planifiee-meta {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-bottom: 10px;
    font-size: 0.9em;
    color: #6c757d;
}

.meta-badge {
    background: #667eea;
    color: white;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.85em;
}

.ingredients-status {
    margin-top: 10px;
}

.status-ready {
    color: #28a745;
    font-weight: 600;
}

.status-partial {
    color: #ff9800;
    font-weight: 600;
}

.ingredients-manquants {
    margin: 8px 0 0 20px;
    font-size: 0.85em;
    color: #6c757d;
}

.ingredients-manquants li {
    margin: 3px 0;
}

.planifiee-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* Responsive */
@media (max-width: 768px) {
    .recette-planifiee-card {
        flex-direction: column;
    }
    
    .planifiee-image {
        width: 100%;
        height: 200px;
    }
    
    .planifiee-actions {
        width: 100%;
        flex-direction: row;
    }
    
    .planifiee-actions .btn {
        flex: 1;
    }
}
</style>
{% endblock %}
