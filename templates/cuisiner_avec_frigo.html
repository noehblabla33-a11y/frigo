{% extends "base.html" %}
{% from "macros/saisons.html" import saison_badge, indicateur_saison %}
{% block title %}Que puis-je cuisiner ?{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ versioned_url_for('static', filename='style/cuisiner-frigo.css') }}">
{% endblock %}

{% block content %}
<div class="page-header">
    <h2>ü•ò Que puis-je cuisiner avec mon frigo ?</h2>
    <p>Recettes recommand√©es selon votre stock, la saison et vos pr√©f√©rences</p>
</div>

{# ============================================ #}
{# STATISTIQUES RAPIDES #}
{# ============================================ #}
<div class="stats-grid" style="margin-bottom: 30px;">
    <div class="stat-card stat-realisable">
        <div class="stat-number">{{ nb_realisables }}</div>
        <div class="stat-label">R√©alisable(s) maintenant</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ nb_total }}</div>
        <div class="stat-label">Recette(s) sugg√©r√©e(s)</div>
    </div>
    <div class="stat-card stat-planifiee">
        <div class="stat-number">{{ planifiees|length }}</div>
        <div class="stat-label">Planifi√©e(s)</div>
    </div>
</div>

{# ============================================ #}
{# SECTION DES RECETTES PLANIFI√âES #}
{# ============================================ #}
{% if planifiees %}
<div class="card">
    <h3>üìÖ Mes recettes planifi√©es</h3>
    <p style="color: #667eea; margin-bottom: 20px;">
        Recettes que vous avez planifi√©es et qui attendent d'√™tre pr√©par√©es
    </p>
    
    <div class="planifiees-container">
        {% for plan in planifiees %}
        <div class="recette-planifiee-card">
            <div class="planifiee-image">
                {% if plan.recette_ref.image %}
                <img src="{{ url_for('static', filename=plan.recette_ref.image|image_path) }}" 
                     alt="{{ plan.recette_ref.nom }}"
                     loading="lazy">
                {% else %}
                <div class="no-image-small">üç≥</div>
                {% endif %}
            </div>
            
            <div class="planifiee-info">
                <h4>
                    <a href="{{ url_for('recettes.detail', id=plan.recette_ref.id) }}">
                        {{ plan.recette_ref.nom }}
                    </a>
                </h4>
                
                <div class="planifiee-meta">
                    {% if plan.recette_ref.type_recette %}
                    <span class="meta-badge">{{ plan.recette_ref.type_recette }}</span>
                    {% endif %}
                    <span class="meta-ingredients">{{ plan.recette_ref.ingredients|length }} ingr√©dient(s)</span>
                    {% if plan.recette_ref.temps_preparation %}
                    <span class="meta-temps">‚è±Ô∏è {{ plan.recette_ref.temps_preparation }} min</span>
                    {% endif %}
                </div>
                
                {# Statut des ingr√©dients #}
                <div class="ingredients-status">
                    {% set disponibilite = plan.recette_ref.calculer_disponibilite_ingredients() %}
                    {% if disponibilite.realisable %}
                    <span class="status-ready">‚úì Tous les ingr√©dients sont disponibles</span>
                    {% else %}
                    <span class="status-partial">
                        ‚ö†Ô∏è {{ disponibilite.ingredients_manquants|length }} ingr√©dient(s) manquant(s)
                    </span>
                    <ul class="ingredients-manquants">
                        {% for ing in disponibilite.ingredients_manquants[:3] %}
                        <li>{{ ing.ingredient.nom }}: {{ ing.quantite_manquante }} {{ ing.ingredient.unite }}</li>
                        {% endfor %}
                        {% if disponibilite.ingredients_manquants|length > 3 %}
                        <li>Et {{ disponibilite.ingredients_manquants|length - 3 }} autre(s)...</li>
                        {% endif %}
                    </ul>
                    {% endif %}
                </div>
            </div>
            
            <div class="planifiee-actions">
                <a href="{{ url_for('planification.preparer', id=plan.id) }}" 
                   class="btn btn-success btn-small">
                    ‚úì Marquer comme pr√©par√©e
                </a>
                <a href="{{ url_for('planification.annuler', id=plan.id) }}" 
                   class="btn btn-danger btn-small"
                   onclick="return confirm('Annuler cette planification ?')">
                    ‚úñ Annuler
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{# ============================================ #}
{# PANNEAU DE CONFIGURATION DES RECOMMANDATIONS #}
{# ============================================ #}
<div class="card config-card">
    <h3 data-collapsable="reco-config" class="collapsable-header">
        ‚öôÔ∏è Personnaliser les recommandations
    </h3>
    <div id="reco-config" class="collapsable-content" style="display: none;">
        <form method="GET" id="reco-form">
            {# Filtres de base #}
            <div class="config-section">
                <h4>üîç Filtres</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Saison</label>
                        <select name="saison" class="form-control">
                            {% for saison_code, saison_emoji in saisons %}
                            <option value="{{ saison_code }}" {% if saison == saison_code %}selected{% endif %}>
                                {{ saison_emoji }} 
                                {% if saison_code == 'printemps' %}Printemps
                                {% elif saison_code == 'ete' %}√ât√©
                                {% elif saison_code == 'automne' %}Automne
                                {% elif saison_code == 'hiver' %}Hiver
                                {% endif %}
                                {% if saison_code == saison_actuelle %}(actuelle){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Type de recette</label>
                        <select name="type" class="form-control">
                            <option value="">Tous les types</option>
                            {% for type in types_recettes %}
                            <option value="{{ type }}" {% if type_filter == type %}selected{% endif %}>
                                {{ type }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="realisable" value="1" 
                                   {% if realisable_only %}checked{% endif %}>
                            Uniquement r√©alisables
                        </label>
                    </div>
                </div>
            </div>
            
            {# Pond√©ration des crit√®res #}
            <div class="config-section">
                <h4>‚öñÔ∏è Importance des crit√®res</h4>
                <p class="config-help">
                    Ajustez l'importance de chaque crit√®re (0 = ignor√©, 100% = prioritaire)
                </p>
                
                <div class="criteres-grid">
                    {% for nom, config in criteres_config.items() %}
                    <div class="critere-slider">
                        <label>
                            <span class="critere-emoji">{{ config.emoji }}</span>
                            {{ config.description }}
                        </label>
                        <div class="slider-container">
                            <input type="range" 
                                   name="poids_{{ nom }}" 
                                   min="0" max="1" step="0.1"
                                   value="{{ config.poids }}"
                                   class="slider"
                                   oninput="this.nextElementSibling.textContent = Math.round(this.value * 100) + '%'">
                            <span class="slider-value">{{ (config.poids * 100)|round|int }}%</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    üîÑ Appliquer
                </button>
                <a href="{{ url_for('recettes.cuisiner_avec_frigo') }}" class="btn btn-secondary">
                    ‚Ü∫ R√©initialiser
                </a>
            </div>
        </form>
    </div>
</div>

{# ============================================ #}
{# LISTE DES RECOMMANDATIONS #}
{# ============================================ #}
<div class="card">
    <div class="reco-header-bar">
        <h3>üéØ Recettes recommand√©es</h3>
        <div class="reco-info">
            {{ saison_badge(saison) }}
            {% if realisable_only %}
            <span class="filter-badge">R√©alisables uniquement</span>
            {% endif %}
            {% if type_filter %}
            <span class="filter-badge">{{ type_filter }}</span>
            {% endif %}
        </div>
    </div>
    
    {% if recommandations %}
    <div class="recettes-reco-grid">
        {% for reco in recommandations %}
        {% set recette = reco.recette %}
        {% set dispo = reco.meta.get('disponibilite', {}) %}
        {% set is_realisable = dispo.get('realisable', False) %}
        
        <div class="recette-reco-card {% if is_realisable %}realisable{% endif %}">
            {# Image #}
            <a href="{{ url_for('recettes.detail', id=recette.id) }}" class="recette-image-link">
                <div class="recette-image">
                    {% if recette.image %}
                    <img src="{{ url_for('static', filename=recette.image.replace('static/', '')) }}" 
                         alt="{{ recette.nom }}"
                         loading="lazy">
                    {% else %}
                    <div class="no-image">üç≥</div>
                    {% endif %}
                    
                    {# Badge type #}
                    {% if recette.type_recette %}
                    <span class="recette-type-badge">{{ recette.type_recette }}</span>
                    {% endif %}
                    
                    {# Badge r√©alisable #}
                    {% if is_realisable %}
                    <span class="badge-realisable">‚úì R√©alisable</span>
                    {% endif %}
                    
                    {# Score badge #}
                    <div class="score-badge-overlay 
                        {% if reco.score_total >= 80 %}excellent
                        {% elif reco.score_total >= 60 %}bon
                        {% elif reco.score_total >= 40 %}moyen
                        {% else %}faible{% endif %}">
                        {{ reco.score_total|round|int }}
                    </div>
                </div>
            </a>
            
            {# Contenu #}
            <div class="recette-content">
                <h4>
                    <a href="{{ url_for('recettes.detail', id=recette.id) }}">
                        {{ recette.nom }}
                    </a>
                </h4>
                
                <div class="recette-meta">
                    <span>{{ recette.ingredients|length }} ing.</span>
                    {% if recette.temps_preparation %}
                    <span>‚è±Ô∏è {{ recette.temps_preparation }} min</span>
                    {% endif %}
                    {% set cout = recette.calculer_cout() %}
                    {% if cout > 0 %}
                    <span>üí∞ {{ "%.2f"|format(cout) }}‚Ç¨</span>
                    {% endif %}
                </div>
                
                {# Barre de disponibilit√© #}
                <div class="disponibilite-bar">
                    <div class="disponibilite-progress" 
                         style="width: {{ reco.scores_details.disponibilite|default(0) }}%; 
                                background: {% if is_realisable %}#28a745{% elif reco.scores_details.disponibilite|default(0) >= 75 %}#ffc107{% elif reco.scores_details.disponibilite|default(0) >= 50 %}#ff9800{% else %}#f44336{% endif %};">
                    </div>
                </div>
                
                {# Scores d√©taill√©s (compact) #}
                <div class="scores-mini">
                    {% if reco.scores_details.saison is defined %}
                    <span class="score-mini saison" title="Score saisonnier">
                        üåø {{ reco.scores_details.saison|round|int }}%
                    </span>
                    {% endif %}
                    <span class="score-mini dispo" title="Stock disponible">
                        ‚ùÑÔ∏è {{ reco.scores_details.disponibilite|default(0)|round|int }}%
                        {% if not is_realisable and dispo.nb_manquants %}
                        <small>({{ dispo.nb_manquants }} manquant{% if dispo.nb_manquants > 1 %}s{% endif %})</small>
                        {% endif %}
                    </span>
                </div>
            </div>
            
            {# Actions #}
            <div class="recette-actions">
                <form method="POST" 
                      action="{{ url_for('recettes.planifier_rapide', id=recette.id) }}" 
                      style="display: inline;">
                    <input type="hidden" name="next" value="{{ request.url }}">
                    <button type="submit" 
                            class="btn btn-small {% if is_realisable %}btn-success{% else %}btn-primary{% endif %}">
                        üìÖ Planifier
                    </button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    
    {% if recommandations|length >= limit %}
    <p style="margin-top: 20px; text-align: center; color: #6c757d;">
        <a href="{{ url_for('recettes.cuisiner_avec_frigo', limit=limit+20, saison=saison, type=type_filter, realisable='1' if realisable_only else '') }}" class="btn btn-secondary">
            Voir plus de recettes
        </a>
    </p>
    {% endif %}
    
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">üîç</div>
        <p>Aucune recette ne correspond √† vos crit√®res.</p>
        <p class="empty-hint">
            {% if realisable_only %}
            Essayez de d√©sactiver le filtre "Uniquement r√©alisables" ou 
            <a href="{{ url_for('courses.liste') }}">faites vos courses</a>.
            {% else %}
            <a href="{{ url_for('recettes.liste') }}">Ajoutez des recettes</a> ou 
            <a href="{{ url_for('frigo.liste') }}">remplissez votre frigo</a>.
            {% endif %}
        </p>
    </div>
    {% endif %}
</div>

{# Lien vers la page compl√®te de recommandations #}
<div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
    <a href="{{ url_for('recommandations.index') }}" class="btn">
        üéØ Page compl√®te des recommandations
    </a>
    <a href="{{ url_for('recettes.liste') }}" class="btn btn-secondary">
        ‚Üê Toutes les recettes
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ versioned_url_for('static', filename='javascript/collapsable.js') }}"></script>
{% endblock %}
