{% extends "base.html" %}
{% from "macros/saisons.html" import saison_badge, score_saisonnier %}
{% block title %}Recommandations{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ versioned_url_for('static', filename='style/recommandations.css') }}">
{% endblock %}

{% block content %}
<script>document.body.dataset.page = 'recommandations';</script>

{# ============================================ #}
{# EN-T√äTE #}
{# ============================================ #}
<div class="reco-header">
    <div class="reco-header-content">
        <h2>üéØ Recommandations de recettes</h2>
        <p class="subtitle">
            Recettes sugg√©r√©es pour 
            {{ saison_badge(saison) }}
            {% if saison == saison_actuelle %}
            <span class="badge badge-success">Saison actuelle</span>
            {% endif %}
        </p>
    </div>
    
    {# Presets rapides #}
    <div class="presets-bar">
        <span class="presets-label">Profils :</span>
        <a href="{{ url_for('recommandations.preset', preset='saison') }}" 
           class="preset-btn {% if request.args.get('poids_saison') == '1.0' %}active{% endif %}">
            üåø De saison
        </a>
        <a href="{{ url_for('recommandations.preset', preset='frigo') }}" 
           class="preset-btn {% if request.args.get('poids_disponibilite') == '1.0' and realisable_only %}active{% endif %}">
            ‚ùÑÔ∏è Avec mon frigo
        </a>
        <a href="{{ url_for('recommandations.preset', preset='economique') }}" 
           class="preset-btn {% if request.args.get('poids_cout') == '1.0' %}active{% endif %}">
            üí∞ √âconomique
        </a>
        <a href="{{ url_for('recommandations.preset', preset='rapide') }}" 
           class="preset-btn {% if request.args.get('poids_temps') == '1.0' %}active{% endif %}">
            ‚è±Ô∏è Rapide
        </a>
        <a href="{{ url_for('recommandations.preset', preset='equilibre') }}" 
           class="preset-btn">
            ‚öñÔ∏è √âquilibr√©
        </a>
    </div>
</div>

{# ============================================ #}
{# PANNEAU DE CONFIGURATION #}
{# ============================================ #}
<div class="card config-card">
    <h3 data-collapsable="config-form" class="collapsable-header">
        ‚öôÔ∏è Personnaliser les crit√®res
    </h3>
    <div id="config-form" class="collapsable-content" style="display: none;">
        <form method="GET" id="reco-form">
            {# Filtres de base #}
            <div class="config-section">
                <h4>üîç Filtres</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Saison</label>
                        <select name="saison" class="form-control">
                            {% for saison_code, saison_emoji in saisons %}
                            <option value="{{ saison_code }}" {% if saison == saison_code %}selected{% endif %}>
                                {{ saison_emoji }} 
                                {% if saison_code == 'printemps' %}Printemps
                                {% elif saison_code == 'ete' %}√ât√©
                                {% elif saison_code == 'automne' %}Automne
                                {% elif saison_code == 'hiver' %}Hiver
                                {% endif %}
                                {% if saison_code == saison_actuelle %}(actuelle){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Type de recette</label>
                        <select name="type" class="form-control">
                            <option value="">Tous les types</option>
                            {% for type in types_recettes %}
                            <option value="{{ type }}" {% if type_filter == type %}selected{% endif %}>
                                {{ type }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Nombre de r√©sultats</label>
                        <select name="limit" class="form-control">
                            <option value="10" {% if limit == 10 %}selected{% endif %}>10</option>
                            <option value="20" {% if limit == 20 %}selected{% endif %}>20</option>
                            <option value="50" {% if limit == 50 %}selected{% endif %}>50</option>
                        </select>
                    </div>
                    
                    <div class="form-group checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="realisable" value="1" 
                                   {% if realisable_only %}checked{% endif %}>
                            Uniquement r√©alisables
                        </label>
                    </div>
                </div>
            </div>
            
            {# Pond√©ration des crit√®res #}
            <div class="config-section">
                <h4>‚öñÔ∏è Pond√©ration des crit√®res</h4>
                <p class="config-help">
                    Ajustez l'importance de chaque crit√®re (0 = ignor√©, 100% = prioritaire)
                </p>
                
                <div class="criteres-grid">
                    {% for nom, config in criteres_config.items() %}
                    <div class="critere-slider">
                        <label>
                            <span class="critere-emoji">{{ config.emoji }}</span>
                            {{ config.description }}
                        </label>
                        <div class="slider-container">
                            <input type="range" 
                                   name="poids_{{ nom }}" 
                                   min="0" max="1" step="0.1"
                                   value="{{ config.poids }}"
                                   class="slider"
                                   oninput="this.nextElementSibling.textContent = Math.round(this.value * 100) + '%'">
                            <span class="slider-value">{{ (config.poids * 100)|round|int }}%</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    üîÑ Appliquer
                </button>
                <a href="{{ url_for('recommandations.index') }}" class="btn btn-secondary">
                    ‚Ü∫ R√©initialiser
                </a>
            </div>
        </form>
    </div>
</div>

{# ============================================ #}
{# LISTE DES RECOMMANDATIONS #}
{# ============================================ #}
<div class="card">
    <div class="reco-results-header">
        <h3>üìã {{ recommandations|length }} recette(s) recommand√©e(s)</h3>
    </div>
    
    {% if recommandations %}
    <div class="reco-list">
        {% for reco in recommandations %}
        {% set recette = reco.recette %}
        <div class="reco-item" data-score="{{ reco.score_total }}">
            {# Image #}
            <div class="reco-image">
                {% if recette.image %}
                <img src="{{ url_for('static', filename=ing.image|image_path) }}" 
                     alt="{{ recette.nom }}" loading="lazy">
                {% else %}
                <div class="reco-image-placeholder">üç≥</div>
                {% endif %}
            </div>
            
            {# Contenu principal #}
            <div class="reco-content">
                <div class="reco-title">
                    <a href="{{ url_for('recettes.detail', id=recette.id) }}">
                        {{ recette.nom }}
                    </a>
                    {% if recette.type_recette %}
                    <span class="badge">{{ recette.type_recette }}</span>
                    {% endif %}
                </div>
                
                <div class="reco-meta">
                    {% if recette.temps_preparation %}
                    <span class="meta-item">‚è±Ô∏è {{ recette.temps_preparation }} min</span>
                    {% endif %}
                    <span class="meta-item">üì¶ {{ recette.ingredients|length }} ingr√©dients</span>
                    {% set cout = recette.calculer_cout() %}
                    {% if cout > 0 %}
                    <span class="meta-item">üí∞ {{ "%.2f"|format(cout) }}‚Ç¨</span>
                    {% endif %}
                </div>
                
                {# D√©tails des scores #}
                <div class="reco-scores">
                    {% if reco.scores_details.saison is defined %}
                    <span class="score-badge saison" title="Score saisonnier">
                        üåø {{ reco.scores_details.saison|round|int }}%
                    </span>
                    {% endif %}
                    
                    {% if reco.scores_details.disponibilite is defined %}
                    {% set dispo = reco.meta.disponibilite %}
                    <span class="score-badge disponibilite {% if dispo.realisable %}realisable{% endif %}" 
                          title="Disponibilit√© des ingr√©dients">
                        ‚ùÑÔ∏è {{ reco.scores_details.disponibilite|round|int }}%
                        {% if dispo.realisable %}‚úì{% endif %}
                    </span>
                    {% endif %}
                    
                    {% if reco.scores_details.variete is defined and reco.meta.variete.dans_historique %}
                    <span class="score-badge variete" title="Cuisin√© r√©cemment">
                        üîÑ #{{ reco.meta.variete.position }}
                    </span>
                    {% endif %}
                </div>
            </div>
            
            {# Score total #}
            <div class="reco-score-total">
                <div class="score-circle 
                    {% if reco.score_total >= 80 %}excellent
                    {% elif reco.score_total >= 60 %}bon
                    {% elif reco.score_total >= 40 %}moyen
                    {% else %}faible{% endif %}">
                    {{ reco.score_total|round|int }}
                </div>
                <span class="score-label">Score</span>
            </div>
            
            {# Actions #}
            <div class="reco-actions">
                <a href="{{ url_for('recettes.detail', id=recette.id) }}" class="btn btn-sm">
                    üëÅÔ∏è Voir
                </a>
                <form method="POST" action="{{ url_for('recettes.planifier_rapide', id=recette.id) }}" style="display: inline;">
                    <input type="hidden" name="next" value="{{ request.url }}">
                    <button type="submit" class="btn btn-sm btn-success">
                        üìÖ Planifier
                    </button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">üîç</div>
        <p>Aucune recette ne correspond √† vos crit√®res.</p>
        <p class="empty-hint">
            {% if realisable_only %}
            Essayez de d√©sactiver le filtre "Uniquement r√©alisables" ou 
            <a href="{{ url_for('courses.liste') }}">faites vos courses</a>.
            {% else %}
            Ajoutez des recettes ou ajustez les crit√®res.
            {% endif %}
        </p>
    </div>
    {% endif %}
</div>

{# Retour #}
<div style="margin-top: 20px;">
    <a href="{{ url_for('recettes.liste') }}" class="btn btn-secondary">
        ‚Üê Retour aux recettes
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ versioned_url_for('static', filename='javascript/collapsable.js') }}"></script>
<script>
// Auto-submit quand on change un filtre (optionnel)
document.querySelectorAll('#reco-form select').forEach(select => {
    select.addEventListener('change', function() {
        // Optionnel : auto-submit apr√®s un d√©lai
        // setTimeout(() => this.form.submit(), 300);
    });
});
</script>
{% endblock %}
