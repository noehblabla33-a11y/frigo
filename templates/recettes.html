{% extends "base.html" %}
{% from "macros/pagination.html" import render_pagination %}
{% from "macros/search_filters.html" import render_search_form, render_empty_state %}
{% block title %}Mes recettes{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='style/recettes.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style/pagination.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style/collapsable.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style/list-grid-view.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style/search-filters.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style/recettes-form-premium.css') }}">
{% endblock %}

{% block content %}
<script>document.body.dataset.page = 'recettes';</script>

{# ============================================ #}
{# FORMULAIRE DE RECHERCHE (FACTORIS√â) #}
{# ============================================ #}
{% set type_options = [] %}
{% for type in types_recettes %}
    {% set _ = type_options.append({'value': type, 'text': type}) %}
{% endfor %}

{% set ingredient_options = [] %}
{% for ing in ingredients %}
    {% set _ = ingredient_options.append({'value': ing.id, 'text': ing.nom}) %}
{% endfor %}

{% set filters = [
    {
        'name': 'type',
        'label': 'Type',
        'type': 'select',
        'placeholder': 'Tous les types',
        'options': type_options,
        'selected': type_filter
    },
    {
        'name': 'ingredient',
        'label': 'Ingr√©dient',
        'type': 'select',
        'searchable': true,
        'placeholder': 'Tous les ingr√©dients',
        'options': ingredient_options,
        'selected': ingredient_filter
    }
] %}

{% set active_filters = {} %}
{% if type_filter %}
    {% set _ = active_filters.update({'type': {'label': 'Type', 'value': type_filter}}) %}
{% endif %}
{% if ingredient_filter %}
    {% for ing in ingredients %}
        {% if ing.id == ingredient_filter|int %}
            {% set _ = active_filters.update({'ingredient': {'label': 'Ingr√©dient', 'value': ingredient_filter, 'display': ing.nom}}) %}
        {% endif %}
    {% endfor %}
{% endif %}

{{ render_search_form(
    endpoint='recettes.liste',
    search_value=search_query,
    search_placeholder='Ex: Poulet, Tarte...',
    filters=filters,
    active_filters=active_filters
) }}

{# Afficher le nombre de r√©sultats si filtres actifs #}
{% if (search_query or type_filter or ingredient_filter) and pagination.total is defined %}
<div style="margin: -10px 0 20px 0; padding-left: 5px;">
    <span style="color: var(--text-secondary);">{{ pagination.total }} r√©sultat(s)</span>
</div>
{% endif %}

{# ============================================ #}
{# FORMULAIRE D'AJOUT (COLLAPSABLE) #}
{# ============================================ #}
<div style="margin-bottom: 20px;">
    <button onclick="openModal('modal-add-recette')" class="btn-open-modal">
        ‚ûï Ajouter une recette
    </button>
</div>

<!-- Modal -->
<div id="modal-add-recette" class="modal-overlay">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title">‚ûï Ajouter une recette</h3>
            <button class="modal-close" onclick="closeModal('modal-add-recette')">‚úï</button>
        </div>
        <div class="modal-body">
        {% from "macros/forms.html" import premium_section, info_grid, input_premium, select_premium, textarea_premium, image_upload_premium, ingredients_list_premium, etapes_list_premium, submit_hero %}
            <form method="POST" enctype="multipart/form-data">
                <!-- COPIER TOUT LE FORMULAIRE ICI -->

                {# SECTION 1 : Informations g√©n√©rales #}
                {% call premium_section(1, "Informations g√©n√©rales", "Nom, type et photo de votre recette") %}
                    
                    {% call info_grid(3) %}
                        {{ input_premium('nom', label='Nom de la recette', 
                                        placeholder='Ex: Tarte aux pommes maison', required=true) }}
                        
                        {% set type_options = [
                            ('Entr√©e', 'ü•ó Entr√©e'),
                            ('Plat', 'üçΩÔ∏è Plat'),
                            ('Dessert', 'üç∞ Dessert')
                        ] %}
                        {{ select_premium('type', label='Type', options=type_options, 
                                        placeholder='Choisir...') }}
                        
                        {{ input_premium('temps_preparation', label='Temps (min)', type='number',
                                        placeholder='30', min=1) }}
                    {% endcall %}
                    
                    {{ image_upload_premium('image') }}
                    
                    {{ textarea_premium('description', label='Description',
                                    placeholder='D√©crivez votre recette en quelques mots...', rows=3,
                                    help_text='Une petite description donnera envie de la cuisiner !') }}
                    
                {% endcall %}
                
                {# SECTION 2 : Ingr√©dients #}
                {% call premium_section(2, "Ingr√©dients", "Liste des ingr√©dients n√©cessaires") %}
                    {{ ingredients_list_premium(all_ingredients=ingredients) }}
                {% endcall %}
                
                {# SECTION 3 : Pr√©paration #}
                {% call premium_section(3, "Pr√©paration", "√âtapes d√©taill√©es de la recette") %}
                    {{ etapes_list_premium() }}
                {% endcall %}
                
                {# BOUTON SUBMIT #}
                {{ submit_hero('Cr√©er ma recette', '‚úì') }}
            </form>
        </div>
    </div>
</div>
{# ============================================ #}
{# LISTE DES RECETTES #}
{# ============================================ #}
<div class="card">
    <div class="catalogue-header">
        <h3>üìñ Mes recettes</h3>
    </div>
    
    {% if recettes %}
        <div class="item-list">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 60px;"></th>
                        <th>Nom</th>
                        <th>Type</th>
                        <th>Ingr√©dients</th>
                        <th>Temps</th>
                        <th>Co√ªt</th>
                        <th style="text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for recette in recettes %}
                    <tr>
                        <td class="item-img-cell">
                            {% if recette.image %}
                            <img src="{{ url_for('static', filename=recette.image|image_path) }}" 
                                alt="{{ recette.nom }}" 
                                class="item-thumbnail"
                                loading="lazy">
                            {% else %}
                            <div class="item-thumbnail-placeholder">üç≥</div>
                            {% endif %}
                        </td>
                        <td class="item-name-cell">
                            <a href="{{ url_for('recettes.detail', id=recette.id) }}" class="recette-link-table">
                                <strong>{{ recette.nom }}</strong>
                            </a>
                        </td>
                        <td>
                            {% if recette.type_recette %}
                            <span class="badge">{{ recette.type_recette }}</span>
                            {% else %}
                            <span style="color: #adb5bd;">-</span>
                            {% endif %}
                        </td>
                        <td>{{ recette.ingredients|length }} ing.</td>
                        <td>
                            {% if recette.temps_preparation %}
                            {{ recette.temps_preparation }} min
                            {% else %}
                            <span style="color: #adb5bd;">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% set cout = recette.calculer_cout() %}
                            {% if cout > 0 %}
                            {{ "%.2f"|format(cout) }}‚Ç¨
                            {% else %}
                            <span style="color: #adb5bd;">-</span>
                            {% endif %}
                        </td>
                        <td class="actions-cell">
                            <form method="POST" action="{{ url_for('recettes.planifier_rapide', id=recette.id) }}" style="display: inline;">
                                <input type="hidden" name="next" value="{{ request.url }}">
                                <button type="submit" class="btn-icon" title="Planifier">üìÖ</button>
                            </form>
                            <a href="{{ url_for('recettes.modifier', id=recette.id) }}" 
                               class="btn-icon" 
                               title="Modifier">‚úèÔ∏è</a>
                            {# ‚úÖ FACTORIS√â : Utilisation de data-confirm #}
                            <a href="{{ url_for('recettes.supprimer', id=recette.id) }}" 
                               class="btn-icon btn-icon-danger" 
                               title="Supprimer"
                               data-confirm="Supprimer la recette ¬´ {{ recette.nom }} ¬ª ?">üóëÔ∏è</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {# Pagination #}
        {{ render_pagination(pagination, 'recettes.liste',
                           search=search_query,
                           type=type_filter,
                           ingredient=ingredient_filter) }}
    {% else %}
        {# √âtat vide (factoris√©) #}
        {{ render_empty_state(
            icon='üìñ',
            message='Aucune recette trouv√©e.',
            has_filters=(search_query or type_filter or ingredient_filter),
            filter_message='Essayez de modifier vos crit√®res de recherche.',
            add_message='Utilisez le formulaire ci-dessus pour en cr√©er une !'
        ) }}
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{# Note: common.js est d√©j√† inclus dans base.html #}
<script src="{{ url_for('static', filename='javascript/collapsable.js') }}"></script>
<script src="{{ url_for('static', filename='javascript/recettes.js') }}"></script>
<script src="{{ url_for('static', filename='javascript/ingredient-units.js') }}"></script>

<script>
(function() {
    'use strict';
    
    // ============================================
    // CONFIGURATION DES LISTES DYNAMIQUES
    // ============================================
    
    // Template pour un nouvel ingr√©dient
    function getIngredientTemplate(index) {
        return `
            <div class="ingredient-row dynamic-item" data-index="${index}">
                <div class="form-group" style="flex: 2;">
                    <select name="ingredient_${index}" class="ingredient-select searchable-select" required>
                        <option value="">S√©lectionner...</option>
                        {% for ing in ingredients %}
                        <option value="{{ ing.id }}" data-unite="{{ ing.unite }}">{{ ing.nom }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <input type="number" step="1" name="quantite_${index}" 
                           placeholder="Quantit√©" class="quantite-input" required>
                </div>
                <div class="form-group unite-display" style="flex: 0.5;">
                    <span class="unite-label">-</span>
                </div>
                <button type="button" class="btn-icon btn-icon-danger btn-remove">üóëÔ∏è</button>
            </div>
        `;
    }
    
    // Template pour une nouvelle √©tape
    function getEtapeTemplate(index) {
        return `
            <div class="etape-row dynamic-item" data-index="${index}">
                <div class="etape-number">${index + 1}</div>
                <div class="etape-inputs">
                    <div class="form-group" style="flex: 3; margin-bottom: 0;">
                        <textarea name="etape_desc_${index}" 
                                placeholder="D√©crivez cette √©tape..." rows="2"></textarea>
                    </div>
                    <div class="form-group" style="flex: 1; margin-bottom: 0;">
                        <input type="number" name="etape_duree_${index}" 
                               placeholder="‚è±Ô∏è Min" min="0">
                    </div>
                </div>
                <button type="button" class="btn-icon btn-icon-danger btn-remove">üóëÔ∏è</button>
            </div>
        `;
    }
    
    // ============================================
    // INITIALISATION
    // ============================================
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialiser la liste d'ingr√©dients avec DynamicList
        const ingredientsList = new DynamicList('ingredients-container', {
            itemSelector: '.ingredient-row',
            removeButtonSelector: '.btn-remove',
            minItems: 0,
            onAdd: function(item, index) {
                // Initialiser le select searchable
                const select = item.querySelector('.ingredient-select');
                if (select && window.SelectSearch) {
                    new window.SelectSearch(select);
                }
                // Configurer l'affichage de l'unit√©
                if (select) {
                    select.addEventListener('change', function() {
                        const option = this.options[this.selectedIndex];
                        const unite = option.dataset.unite || '-';
                        const uniteLabel = item.querySelector('.unite-label');
                        if (uniteLabel) uniteLabel.textContent = unite;
                    });
                }
            }
        });
        
        // Initialiser la liste d'√©tapes avec DynamicList
        const etapesList = new DynamicList('etapes-container', {
            itemSelector: '.etape-row',
            removeButtonSelector: '.btn-remove',
            minItems: 0,
            onRemove: function() {
                // Renumeroter apr√®s suppression
                etapesList.renumber('.etape-number');
            }
        });
        
        // Bouton ajouter ingr√©dient
        document.getElementById('btn-add-ingredient')?.addEventListener('click', function() {
            ingredientsList.add(getIngredientTemplate);
        });
        
        // Bouton ajouter √©tape
        document.getElementById('btn-add-etape')?.addEventListener('click', function() {
            const newItem = etapesList.add(getEtapeTemplate);
            // Renumeroter toutes les √©tapes
            etapesList.renumber('.etape-number');
        });
        
        // D√©l√©gation d'√©v√©nements pour les boutons supprimer
        document.getElementById('ingredients-container')?.addEventListener('click', function(e) {
            if (e.target.closest('.btn-remove')) {
                const item = e.target.closest('.dynamic-item');
                if (item) {
                    ingredientsList.remove(parseInt(item.dataset.index));
                }
            }
        });
        
        document.getElementById('etapes-container')?.addEventListener('click', function(e) {
            if (e.target.closest('.btn-remove')) {
                const item = e.target.closest('.dynamic-item');
                if (item) {
                    etapesList.remove(parseInt(item.dataset.index));
                }
            }
        });
        
        // Initialiser les selects existants
        document.querySelectorAll('.ingredient-select').forEach(select => {
            select.addEventListener('change', function() {
                const option = this.options[this.selectedIndex];
                const unite = option.dataset.unite || '-';
                const row = this.closest('.ingredient-row');
                const uniteLabel = row?.querySelector('.unite-label');
                if (uniteLabel) uniteLabel.textContent = unite;
            });
        });
    });
})();
</script>
{% endblock %}
