{% extends "base.html" %}
{% from "macros/pagination.html" import render_pagination %}
{% from "macros/search_filters.html" import render_search_form, render_empty_state %}
{% block title %}Mes recettes{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='style/recettes.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style/pagination.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style/collapsable.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style/list-grid-view.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style/search-filters.css') }}">
{% endblock %}

{% block content %}
<script>document.body.dataset.page = 'recettes';</script>

{# ============================================ #}
{# FORMULAIRE DE RECHERCHE (FACTORIS√â) #}
{# ============================================ #}
{% set type_options = [] %}
{% for type in types_recettes %}
    {% set _ = type_options.append({'value': type, 'text': type}) %}
{% endfor %}

{% set ingredient_options = [] %}
{% for ing in ingredients %}
    {% set _ = ingredient_options.append({'value': ing.id, 'text': ing.nom}) %}
{% endfor %}

{% set filters = [
    {
        'name': 'type',
        'label': 'Type',
        'type': 'select',
        'placeholder': 'Tous les types',
        'options': type_options,
        'selected': type_filter
    },
    {
        'name': 'ingredient',
        'label': 'Ingr√©dient',
        'type': 'select',
        'searchable': true,
        'placeholder': 'Tous les ingr√©dients',
        'options': ingredient_options,
        'selected': ingredient_filter
    }
] %}

{% set active_filters = {} %}
{% if type_filter %}
    {% set _ = active_filters.update({'type': {'label': 'Type', 'value': type_filter}}) %}
{% endif %}
{% if ingredient_filter %}
    {% for ing in ingredients %}
        {% if ing.id == ingredient_filter|int %}
            {% set _ = active_filters.update({'ingredient': {'label': 'Ingr√©dient', 'value': ingredient_filter, 'display': ing.nom}}) %}
        {% endif %}
    {% endfor %}
{% endif %}

{{ render_search_form(
    endpoint='recettes.liste',
    search_value=search_query,
    search_placeholder='Ex: Poulet, Tarte...',
    filters=filters,
    active_filters=active_filters,
    view_mode=view_mode|default('list')
) }}

{# Afficher le nombre de r√©sultats si filtres actifs #}
{% if (search_query or type_filter or ingredient_filter) and pagination.total is defined %}
<div style="margin: -10px 0 20px 0; padding-left: 5px;">
    <span style="color: var(--text-secondary);">{{ pagination.total }} r√©sultat(s)</span>
</div>
{% endif %}

{# ============================================ #}
{# FORMULAIRE D'AJOUT (COLLAPSABLE) #}
{# ============================================ #}
<div class="card">
    <h3 data-collapsable="add-form" class="collapsable-header">
        ‚ûï Cr√©er une recette
    </h3>
    <div id="add-form" class="collapsable-content">
        <form method="POST" enctype="multipart/form-data">
            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label>Nom de la recette *</label>
                    <input type="text" name="nom" required placeholder="Ex: Poulet r√¥ti aux herbes">
                </div>
                
                <div class="form-group" style="flex: 1;">
                    <label>Type de recette</label>
                    <select name="type_recette">
                        <option value="">Aucun</option>
                        {% for type in types_recettes %}
                        <option value="{{ type }}">{{ type }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group" style="flex: 1;">
                    <label>Temps de pr√©paration (min)</label>
                    <input type="number" name="temps_preparation" min="0" placeholder="Ex: 30">
                </div>
            </div>
            
            <div class="form-group">
                <label>Image</label>
                <input type="file" name="image" accept="image/*">
            </div>
            
            {# Ingr√©dients #}
            <div class="form-group">
                <label>Ingr√©dients</label>
                <div id="ingredients-container">
                    <div class="ingredient-row" data-ingredient-row="0">
                        <div class="form-group" style="flex: 2;">
                            <select name="ingredient_0" class="ingredient-select searchable-select">
                                <option value="">S√©lectionner...</option>
                                {% for ing in ingredients %}
                                <option value="{{ ing.id }}" data-unite="{{ ing.unite }}">
                                    {{ ing.nom }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group" style="flex: 1;">
                            <input type="number" 
                                   step="1" 
                                   name="quantite_0" 
                                   placeholder="Quantit√©" 
                                   class="quantite-input">
                        </div>
                        
                        <div class="form-group unite-display" style="flex: 0.5;">
                            <span class="unite-label">-</span>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-small btn-secondary" onclick="ajouterIngredient()">
                    + Ajouter un ingr√©dient
                </button>
            </div>
            
            {# √âtapes #}
            <div class="form-group">
                <label>√âtapes de pr√©paration</label>
                <p style="font-size: 0.9em; color: #6c757d; margin-bottom: 10px;">
                    Vous pouvez ajouter un minuteur optionnel pour chaque √©tape.
                </p>
                <div id="etapes-container">
                    <div class="etape-row" data-etape="0">
                        <div class="etape-number">1</div>
                        <div class="etape-inputs">
                            <div class="form-group" style="flex: 3; margin-bottom: 0;">
                                <textarea name="etape_desc_0" 
                                        placeholder="Ex: Pr√©chauffer le four √† 180¬∞C"
                                        rows="2"></textarea>
                            </div>
                            <div class="form-group" style="flex: 1; margin-bottom: 0;">
                                <input type="number" 
                                    name="etape_duree_0" 
                                    placeholder="‚è±Ô∏è Minutes (opt.)"
                                    min="0"
                                    title="Dur√©e en minutes pour le minuteur (optionnel)">
                            </div>
                        </div>
                        <button type="button" 
                                class="btn-remove-etape" 
                                onclick="removeEtape(0)"
                                style="display: none;">
                            ‚úñ
                        </button>
                    </div>
                </div>
                <button type="button" onclick="ajouterEtape()" class="btn" style="margin-top: 10px;">
                    + Ajouter une √©tape
                </button>
            </div>
            
            <button type="submit" class="btn btn-success">‚úì Cr√©er la recette</button>
        </form>
    </div>
</div>

{# ============================================ #}
{# LISTE DES RECETTES #}
{# ============================================ #}
<div class="card">
    <div class="catalogue-header">
        <h3>üìñ Mes recettes</h3>
    </div>
    
    {% if recettes %}
        <div class="item-list">
            <table class="item-table">
                <thead>
                    <tr>
                        <th style="width: 60px;"></th>
                        <th>Nom</th>
                        <th>Type</th>
                        <th>Ingr√©dients</th>
                        <th>Temps</th>
                        <th>Co√ªt</th>
                        <th style="text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for recette in recettes %}
                    <tr>
                        <td class="item-img-cell">
                            {% if recette.image %}
                            <img src="{{ url_for('static', filename=recette.image.replace('static/', '')) }}" 
                                alt="{{ recette.nom }}" 
                                class="item-thumbnail"
                                loading="lazy">
                            {% else %}
                            <div class="item-thumbnail-placeholder">üç≥</div>
                            {% endif %}
                        </td>
                        <td class="item-name-cell">
                            <a href="{{ url_for('recettes.detail', id=recette.id) }}" class="recette-link-table">
                                <strong>{{ recette.nom }}</strong>
                            </a>
                        </td>
                        <td>
                            {% if recette.type_recette %}
                            <span class="badge">{{ recette.type_recette }}</span>
                            {% else %}
                            <span style="color: #adb5bd;">-</span>
                            {% endif %}
                        </td>
                        <td>{{ recette.ingredients|length }} ing.</td>
                        <td>
                            {% if recette.temps_preparation %}
                            {{ recette.temps_preparation }} min
                            {% else %}
                            <span style="color: #adb5bd;">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% set cout = recette.calculer_cout() %}
                            {% if cout > 0 %}
                            {{ "%.2f"|format(cout) }}‚Ç¨
                            {% else %}
                            <span style="color: #adb5bd;">-</span>
                            {% endif %}
                        </td>
                        <td class="actions-cell">
                            <form method="POST" action="{{ url_for('recettes.planifier_rapide', id=recette.id) }}" style="display: inline;">
                                <input type="hidden" name="next" value="{{ request.url }}">
                                <button type="submit" class="btn-icon" title="Planifier">üìÖ</button>
                            </form>
                            <a href="{{ url_for('recettes.modifier', id=recette.id) }}" 
                               class="btn-icon" 
                               title="Modifier">‚úèÔ∏è</a>
                            <a href="{{ url_for('recettes.supprimer', id=recette.id) }}" 
                               class="btn-icon btn-icon-danger" 
                               title="Supprimer"
                               onclick="return confirm('Supprimer cette recette ?')">üóëÔ∏è</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {# Pagination #}
        {{ render_pagination(pagination, 'recettes.liste',
                           search=search_query,
                           type=type_filter,
                           ingredient=ingredient_filter,
                           view=view_mode) }}
    {% else %}
        {# √âtat vide (factoris√©) #}
        {{ render_empty_state(
            icon='üìñ',
            message='Aucune recette trouv√©e.',
            has_filters=(search_query or type_filter or ingredient_filter),
            filter_message='Essayez de modifier vos crit√®res de recherche.',
            add_message='Utilisez le formulaire ci-dessus pour en cr√©er une !'
        ) }}
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='javascript/collapsable.js') }}"></script>
<script src="{{ url_for('static', filename='javascript/recettes.js') }}"></script>
<script src="{{ url_for('static', filename='javascript/ingredient-units.js') }}"></script>
<script>
    window.ingredientCount = 1;
    window.etapeCount = 1;
</script>
<script>
// Fonction pour ajouter un nouvel ingr√©dient dynamiquement
function ajouterIngredient() {
    const container = document.getElementById('ingredients-container');
    if (!container) return;
    
    const div = document.createElement('div');
    div.className = 'ingredient-row';
    div.dataset.ingredientRow = ingredientCount;
    div.innerHTML = `
        <div class="form-group" style="flex: 2;">
            <select name="ingredient_${ingredientCount}" class="ingredient-select searchable-select" required>
                <option value="">S√©lectionner...</option>
                {% for ing in ingredients %}
                <option value="{{ ing.id }}" data-unite="{{ ing.unite }}">
                    {{ ing.nom }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group" style="flex: 1;">
            <input type="number" 
                   step="1" 
                   name="quantite_${ingredientCount}" 
                   placeholder="Quantit√©" 
                   class="quantite-input"
                   required>
        </div>
        
        <div class="form-group unite-display" style="flex: 0.5;">
            <span class="unite-label">-</span>
        </div>
        
        <button type="button" class="btn-icon btn-icon-danger" onclick="this.parentElement.remove()">
            üóëÔ∏è
        </button>
    `;
    
    container.appendChild(div);
    ingredientCount++;
    
    // R√©initialiser les selects searchable
    if (typeof initSelectSearch === 'function') {
        initSelectSearch();
    }
}

// Fonction pour ajouter une nouvelle √©tape
function ajouterEtape() {
    const container = document.getElementById('etapes-container');
    if (!container) return;
    
    const etapeNum = container.querySelectorAll('.etape-row').length;
    
    const div = document.createElement('div');
    div.className = 'etape-row';
    div.dataset.etape = etapeCount;
    div.innerHTML = `
        <div class="etape-number">${etapeNum + 1}</div>
        <div class="etape-inputs">
            <div class="form-group" style="flex: 3; margin-bottom: 0;">
                <textarea name="etape_desc_${etapeCount}" 
                        placeholder="Ex: Pr√©chauffer le four √† 180¬∞C"
                        rows="2"></textarea>
            </div>
            <div class="form-group" style="flex: 1; margin-bottom: 0;">
                <input type="number" 
                    name="etape_duree_${etapeCount}" 
                    placeholder="‚è±Ô∏è Minutes (opt.)"
                    min="0"
                    title="Dur√©e en minutes pour le minuteur (optionnel)">
            </div>
        </div>
        <button type="button" 
                class="btn-remove-etape" 
                onclick="removeEtape(${etapeCount})">
            ‚úñ
        </button>
    `;
    
    container.appendChild(div);
    etapeCount++;
    
    // Afficher le bouton supprimer sur la premi√®re √©tape s'il y en a plusieurs
    updateRemoveButtons();
}

// Fonction pour supprimer une √©tape
function removeEtape(index) {
    const etapeRow = document.querySelector(`[data-etape="${index}"]`);
    if (etapeRow) {
        etapeRow.remove();
        renumberEtapes();
        updateRemoveButtons();
    }
}

// Renum√©roter les √©tapes apr√®s suppression
function renumberEtapes() {
    const etapes = document.querySelectorAll('.etape-row');
    etapes.forEach((etape, index) => {
        const numberEl = etape.querySelector('.etape-number');
        if (numberEl) {
            numberEl.textContent = index + 1;
        }
    });
}

// Afficher/masquer les boutons supprimer
function updateRemoveButtons() {
    const etapes = document.querySelectorAll('.etape-row');
    etapes.forEach((etape, index) => {
        const removeBtn = etape.querySelector('.btn-remove-etape');
        if (removeBtn) {
            removeBtn.style.display = etapes.length > 1 ? 'block' : 'none';
        }
    });
}
</script>
{% endblock %}
