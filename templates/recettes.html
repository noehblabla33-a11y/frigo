{% extends "base.html" %}
{% from "macros/pagination.html" import render_pagination %}
{% block title %}Mes recettes{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='style/recettes.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style/pagination.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style/collapsable.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style/list-grid-view.css') }}">
{% endblock %}

{% block content %}
<script>document.body.dataset.page = 'recettes';</script>

<!-- Barre de recherche et filtres -->
<div class="card">
    <h3>üîç Rechercher et filtrer</h3>
    <form method="GET" action="{{ url_for('recettes.liste') }}">
        <div class="search-filters">
            <div class="form-group" style="flex: 2;">
                <label>Recherche par nom</label>
                <input type="text" name="search" placeholder="Ex: Poulet, Tarte..." 
                       value="{{ search_query }}">
            </div>
            
            <div class="form-group" style="flex: 1;">
                <label>Type</label>
                <select name="type">
                    <option value="">Tous les types</option>
                    {% for type in types_recettes %}
                    <option value="{{ type }}" {% if type_filter == type %}selected{% endif %}>
                        {{ type }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group" style="flex: 1;">
                <label>Ingr√©dient</label>
                <select name="ingredient" class="searchable-select">
                    <option value="">Tous les ingr√©dients</option>
                    {% for ing in ingredients %}
                    <option value="{{ ing.id }}" {% if ingredient_filter == ing.id|string %}selected{% endif %}>
                        {{ ing.nom }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group" style="flex: 0; align-self: flex-end;">
                <button type="submit" class="btn">üîç Rechercher</button>
            </div>
            
            {% if search_query or type_filter or ingredient_filter %}
            <div class="form-group" style="flex: 0; align-self: flex-end;">
                <a href="{{ url_for('recettes.liste') }}" class="btn btn-secondary">‚úñ Effacer</a>
            </div>
            {% endif %}
        </div>
        <input type="hidden" name="view" value="{{ view_mode }}">
    </form>
    
    {% if search_query or type_filter or ingredient_filter %}
    <div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 5px;">
        <strong>Filtres actifs :</strong>
        {% if search_query %}
        <span class="filter-badge">Nom: "{{ search_query }}"</span>
        {% endif %}
        {% if type_filter %}
        <span class="filter-badge">Type: {{ type_filter }}</span>
        {% endif %}
        {% if ingredient_filter %}
        {% for ing in ingredients %}
            {% if ing.id == ingredient_filter|int %}
            <span class="filter-badge">Ingr√©dient: {{ ing.nom }}</span>
            {% endif %}
        {% endfor %}
        {% endif %}
        <span style="color: #666;">({{ pagination.total }} r√©sultat(s))</span>
    </div>
    {% endif %}
</div>

<!-- Formulaire de cr√©ation de recette (collapsable) -->
<div class="card card-collapsable">
    <div class="collapsable-header" data-collapsable="form-ajout-recette">
        <h3>‚ûï Cr√©er une nouvelle recette </h3>
    </div>
    
    <div id="form-ajout-recette" class="collapsable-content">    
        <form method="POST" id="recetteForm" enctype="multipart/form-data">
            <div class="form-group">
                <label>Nom de la recette</label>
                <input type="text" name="nom" required>
            </div>
            
            <div class="form-group">
                <label>Type de recette</label>
                <select name="type_recette" class="searchable-select">
                    <option value="">S√©lectionner un type (optionnel)</option>
                    {% for type in types_recettes %}
                    <option value="{{ type }}">{{ type }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label>Temps de pr√©paration (minutes)</label>
                <input type="number" name="temps_preparation" placeholder="Ex: 30">
            </div>
            
            <div class="form-group">
                <label>Image de la recette</label>
                <input type="file" name="image" accept="image/*">
            </div>
            
            <!-- Ingr√©dients -->
            <div class="form-group">
                <label>Ingr√©dients</label>
                <p style="color: #6c757d; font-size: 0.9em; margin-bottom: 15px;">
                    Ajoutez les ingr√©dients n√©cessaires pour cette recette.
                </p>
                
                <div id="ingredients-container" class="ingredients-container">
                    <div class="ingredient-row" data-ingredient-row="0">
                        <div class="form-group" style="flex: 2;">
                            <select name="ingredient_0" class="ingredient-select searchable-select" required>
                                <option value="">S√©lectionner...</option>
                                {% for ing in ingredients %}
                                <option value="{{ ing.id }}" 
                                        data-unite="{{ ing.unite }}"
                                        data-poids-piece="{{ ing.poids_piece if ing.poids_piece else '' }}">
                                    {{ ing.nom }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group" style="flex: 1;">
                            <input type="number" 
                                   step="1" 
                                   name="quantite_0" 
                                   placeholder="Quantit√©"
                                   required>
                        </div>
                        
                        <div class="form-group" style="flex: 0.5;">
                            <input type="text" 
                                   class="unite-display" 
                                   value="g" 
                                   readonly 
                                   style="background: #f0f0f0; cursor: not-allowed; text-align: center; font-weight: 600;">
                        </div>
                        
                        <div class="form-group" style="flex: 2;">
                            <small class="piece-helper" 
                                   style="color: #667eea; 
                                          font-weight: 600; 
                                          display: none; 
                                          line-height: 2.5;">
                            </small>
                        </div>
                        
                        <div class="form-group" style="flex: 0;">
                            <button type="button" 
                                    class="btn-remove-ingredient" 
                                    onclick="removeIngredient(0)"
                                    style="display: none;">
                                ‚úñ
                            </button>
                        </div>
                    </div>
                </div>
                
                <button type="button" onclick="ajouterIngredient()" class="btn" style="margin-top: 10px;">
                    + Ajouter un ingr√©dient
                </button>
            </div>
            
            <!-- √âtapes de pr√©paration -->
            <div class="form-group">
                <label>√âtapes de pr√©paration</label>
                <p style="color: #6c757d; font-size: 0.9em; margin-bottom: 15px;">
                    D√©crivez les √©tapes une par une. Vous pouvez ajouter un minuteur optionnel pour chaque √©tape.
                </p>
                
                <div id="etapes-container">
                    <div class="etape-row" data-etape="0">
                        <div class="etape-number">1</div>
                        <div class="etape-inputs">
                            <div class="form-group" style="flex: 3; margin-bottom: 0;">
                                <textarea name="etape_desc_0" 
                                        placeholder="Ex: Pr√©chauffer le four √† 180¬∞C"
                                        rows="2"></textarea>
                            </div>
                            <div class="form-group" style="flex: 1; margin-bottom: 0;">
                                <input type="number" 
                                    name="etape_duree_0" 
                                    placeholder="‚è±Ô∏è Minutes (opt.)"
                                    min="0"
                                    title="Dur√©e en minutes pour le minuteur (optionnel)">
                            </div>
                        </div>
                        <button type="button" 
                                class="btn-remove-etape" 
                                onclick="removeEtape(0)"
                                style="display: none;">
                            ‚úñ
                        </button>
                    </div>
                </div>
                
                <button type="button" onclick="ajouterEtape()" class="btn" style="margin-top: 10px;">
                    + Ajouter une √©tape
                </button>
            </div>
            
            <button type="submit" class="btn">Cr√©er la recette</button>
        </form>
    </div>
</div>

<!-- Liste des recettes -->
<div class="card">
    <div class="catalogue-header">
        <h3>üìñ Mes recettes</h3>
    </div>
    
    {% if recettes %}
        <div class="item-list">
            <table class="item-table">
                <thead>
                    <tr>
                        <th style="width: 60px;"></th>
                        <th>Nom</th>
                        <th>Type</th>
                        <th>Ingr√©dients</th>
                        <th>Temps</th>
                        <th>Co√ªt</th>
                        <th style="text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for recette in recettes %}
                    {% set cout = recette.calculer_cout() %}
                    <tr>
                        <td class="item-img-cell">
                            {% if recette.image %}
                            <img src="{{ url_for('static', filename=recette.image.replace('static/', '')) }}" 
                                 alt="{{ recette.nom }}" 
                                 class="item-thumbnail"
                                 loading="lazy">
                            {% else %}
                            <div class="item-thumbnail-placeholder">üç≥</div>
                            {% endif %}
                        </td>
                        <td class="item-name-cell">
                            <a href="{{ url_for('recettes.detail', id=recette.id) }}">
                                <strong>{{ recette.nom }}</strong>
                            </a>
                        </td>
                        <td>{{ recette.type_recette or '-' }}</td>
                        <td>{{ recette.ingredients|length }} ingr√©dient(s)</td>
                        <td>
                            {% if recette.temps_preparation %}
                            ‚è±Ô∏è {{ recette.temps_preparation }} min
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            {% if cout > 0 %}
                            <span class="prix-table">{{ cout }}‚Ç¨</span>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td class="actions-cell">
                            <form method="POST" 
                                  action="{{ url_for('recettes.planifier_rapide', id=recette.id) }}" 
                                  style="display: inline;">
                                <button type="submit" 
                                        class="btn btn-small"
                                        style="background: #28a745; color: white;">
                                    üìÖ
                                </button>
                            </form>
                            <a href="{{ url_for('recettes.modifier', id=recette.id) }}" 
                               class="btn btn-small">‚úèÔ∏è</a>
                            <a href="{{ url_for('recettes.supprimer', id=recette.id) }}" 
                               class="btn btn-danger btn-small"
                               onclick="return confirm('Supprimer cette recette ?')">üóëÔ∏è</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {{ render_pagination(pagination, 'recettes.liste',
                           search=search_query,
                           type=type_filter,
                           ingredient=ingredient_filter,
                           view=view_mode) }}
    {% else %}
    <p>Aucune recette trouv√©e. 
        {% if search_query or type_filter or ingredient_filter %}
        Essayez de modifier vos crit√®res de recherche.
        {% else %}
        Utilisez le formulaire ci-dessus pour en cr√©er une !
        {% endif %}
    </p>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='javascript/recettes.js') }}"></script>
<script src="{{ url_for('static', filename='javascript/collapsable.js') }}"></script>
<script src="{{ url_for('static', filename='javascript/ingredient-pieces.js') }}"></script>
<script>
// Fonction pour ajouter un nouvel ingr√©dient dynamiquement
function ajouterIngredient() {
    const container = document.getElementById('ingredients-container');
    if (!container) return;
    
    const div = document.createElement('div');
    div.className = 'ingredient-row';
    div.dataset.ingredientRow = ingredientCount;
    div.innerHTML = `
        <div class="form-group" style="flex: 2;">
            <select name="ingredient_${ingredientCount}" class="ingredient-select searchable-select" required>
                <option value="">S√©lectionner...</option>
                {% for ing in ingredients %}
                <option value="{{ ing.id }}" 
                        data-unite="{{ ing.unite }}"
                        data-poids-piece="{{ ing.poids_piece if ing.poids_piece else '' }}">
                    {{ ing.nom }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group" style="flex: 1;">
            <input type="number" 
                   step="1" 
                   name="quantite_${ingredientCount}" 
                   placeholder="Quantit√©"
                   required>
        </div>
        
        <div class="form-group" style="flex: 0.5;">
            <input type="text" 
                   class="unite-display" 
                   value="g" 
                   readonly 
                   style="background: #f0f0f0; cursor: not-allowed; text-align: center; font-weight: 600;">
        </div>
        
        <div class="form-group" style="flex: 2;">
            <small class="piece-helper" 
                   style="color: #667eea; 
                          font-weight: 600; 
                          display: none; 
                          line-height: 2.5;">
            </small>
        </div>
        
        <div class="form-group" style="flex: 0;">
            <button type="button" 
                    class="btn-remove-ingredient" 
                    onclick="removeIngredient(${ingredientCount})">
                ‚úñ
            </button>
        </div>
    `;
    container.appendChild(div);
    
    // Afficher le bouton de suppression du premier ingr√©dient
    if (ingredientCount === 1) {
        const firstRemove = document.querySelector('.ingredient-row[data-ingredient-row="0"] .btn-remove-ingredient');
        if (firstRemove) firstRemove.style.display = 'inline-block';
    }
    
    ingredientCount++;
    
    // R√©initialiser les helpers pour la nouvelle ligne
    window.IngredientPiecesHelper.init();
}

// Fonction pour supprimer un ingr√©dient
function removeIngredient(index) {
    const row = document.querySelector(`.ingredient-row[data-ingredient-row="${index}"]`);
    if (row) {
        row.remove();
        updateRemoveButtons();
    }
}

// Fonction pour mettre √† jour l'affichage des boutons supprimer
function updateRemoveButtons() {
    const rows = document.querySelectorAll('.ingredient-row');
    rows.forEach((row, idx) => {
        const btn = row.querySelector('.btn-remove-ingredient');
        if (btn) {
            btn.style.display = rows.length > 1 ? 'inline-block' : 'none';
        }
    });
}
</script>
{% endblock %}
